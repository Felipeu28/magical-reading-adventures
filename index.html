<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Magical Reading Adventures — Enhanced & Fixed</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #fff7fb;
      --ink: #2c2152;
      --muted: #6d5db3;
      --brand-1: #ff69b4;
      --brand-2: #9370db;
      --brand-3: #ffd1dc;
      --card: #ffffffee;
      --focus: #222;
      --shadow: 0 8px 20px rgba(147,112,219,.2);
      --shadow-light: 0 4px 12px rgba(147,112,219,.15);
      --border-radius: 1rem;
      --border-radius-lg: 1.25rem;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    
    @media (prefers-color-scheme: dark){
      :root{ 
        --bg:#15121c; 
        --ink:#f7f3ff; 
        --muted:#c8bfff; 
        --card:#1f1a2bee;
        --shadow: 0 8px 20px rgba(0,0,0,.4);
        --shadow-light: 0 4px 12px rgba(0,0,0,.3);
      }
    }
    
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html,body{
      height:100%;
      overflow-x: hidden;
    }
    
    body{
      margin:0;
      font-family:"Baloo 2", system-ui, -apple-system, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(60% 60% at 20% 10%, rgba(255,105,180,.25), transparent 60%),
        radial-gradient(50% 50% at 80% 0%, rgba(147,112,219,.25), transparent 60%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .skip-link{
      position:absolute;
      left:-9999px;
      top:auto;
    }
    .skip-link:focus{
      left:1rem;
      top:1rem;
      background:#fff;
      color:#000;
      padding:.75rem 1rem;
      border-radius:var(--border-radius);
      z-index: 1000;
    }

    .site-header{
      padding:1.5rem 1rem 1rem;
      text-align:center;
      position: relative;
    }
    
    .brand-img{
      width:min(240px, 80vw);
      height:auto;
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      transition: transform 0.3s ease;
    }
    
    .brand-img:hover {
      transform: scale(1.02);
    }
    
    h1{
      margin:.75rem 0 0;
      font-size: clamp(1.75rem, 5vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .tagline{
      color:var(--muted);
      font-size: clamp(1rem, 3vw, 1.1rem);
      margin: 0.5rem 0;
      font-weight: 500;
    }

    .app{
      max-width:1000px;
      margin:0 auto;
      padding:0 1rem 2rem;
    }
    
    .panel{
      background:var(--card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      border-radius:var(--border-radius-lg);
      padding:1.5rem;
      margin:1rem 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-title{
      margin:.25rem 0 1.25rem;
      font-size: clamp(1.25rem, 4vw, 1.5rem);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .age-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }

    .grid{
      display:grid;
      gap:1rem;
      grid-template-columns:repeat(auto-fit,minmax(min(250px, 100%), 1fr));
    }
    
    @media (max-width: 600px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }
    
    .chip{
      font-size:clamp(1.1rem, 3.5vw, 1.25rem);
      font-weight: 600;
      padding:1.25rem 1.5rem;
      border:0;
      cursor:pointer;
      border-radius:var(--border-radius);
      background:linear-gradient(135deg,var(--brand-3), var(--brand-1));
      color:#3a0a4b; 
      box-shadow:var(--shadow-light); 
      min-height:68px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .chip::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.15);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .chip:hover::before,
    .chip:focus::before {
      opacity: 1;
    }
    
    .chip:focus,.chip:hover{
      outline:3px solid var(--focus);
      outline-offset:3px;
      transform:translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .chip:active {
      transform: translateY(0);
    }

    .link{
      background:none;
      border:none;
      color:var(--brand-2);
      cursor:pointer;
      font-size:1.1rem;
      font-weight: 600;
      margin-top:1rem;
      padding: 0.75rem 0;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .link:focus{
      outline:3px solid var(--focus);
      outline-offset:3px;
    }
    .link:hover {
      color: var(--brand-1);
      transform: translateX(-2px);
    }

    .story-controls{
      display:flex;
      gap:.75rem;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 1.5rem;
      padding: 1.25rem;
      background: rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .story-controls button{
      width:56px;
      height:56px;
      border-radius:var(--border-radius);
      border:0;
      background:var(--brand-2);
      color:#fff;
      cursor:pointer;
      box-shadow:var(--shadow-light);
      font-size: 1.3rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .story-controls button:focus{
      outline:3px solid var(--focus);
      outline-offset:3px;
    }
    
    .story-controls button:hover:not(:disabled) {
      background: var(--brand-1);
      transform: translateY(-1px);
    }
    
    .story-controls button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .story-controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      background: var(--muted);
    }
    
    .story-controls button.playing {
      background: var(--success);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .auto-play-indicator {
      background: var(--warning);
      color: white;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .slider{
      display:flex;
      align-items:center;
      gap:.75rem;
      color:var(--muted);
      font-weight: 600;
      margin-left: auto;
    }
    
    .slider input {
      width: 90px;
      accent-color: var(--brand-2);
    }
    
    @media (max-width: 600px) {
      .story-controls {
        justify-content: center;
      }
      .slider, .auto-play-indicator {
        margin-left: 0;
        margin-top: 0.75rem;
      }
    }

    .story-figure{
      margin:1.5rem 0;
      text-align: center;
      position: relative;
    }
    
    .story-image{
      width:100%;
      max-width: 600px;
      height:auto;
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      transition: transform 0.3s ease;
    }
    
    .story-image:hover {
      transform: scale(1.02);
    }
    
    .image-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 1rem;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .hidden{display:none}

    .story-text{
      font-size:clamp(1.2rem, 4vw, 1.4rem);
      line-height:1.8;
      margin-bottom: 2rem;
    }
    
    .story-text .word{
      padding:0.25rem 0.35rem;
      border-radius:0.5rem;
      cursor:pointer;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 0.1rem;
      position: relative;
    }
    
    .story-text .word:hover,
    .story-text .word:focus{
      background:var(--brand-1);
      color:#fff;
      transform: scale(1.05);
      z-index: 1;
    }
    
    .story-text .word:active {
      transform: scale(0.95);
    }
    
    .story-text .word.speaking {
      background: var(--success);
      color: white;
      animation: highlight 0.5s ease;
    }
    
    @keyframes highlight {
      0% { background: var(--warning); }
      100% { background: var(--success); }
    }

    .vocabulary-highlight {
      background: linear-gradient(120deg, #ffd700 0%, #ffed4e 100%);
      color: #2d1810;
      font-weight: 700;
      padding: 0.2rem 0.4rem;
      border-radius: 0.4rem;
      border: 2px solid #e6c200;
      box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 0 0.1rem;
    }
    
    .vocabulary-highlight::before {
      content: "📚";
      position: absolute;
      top: -8px;
      left: -6px;
      font-size: 0.7rem;
      background: var(--info);
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .vocabulary-highlight:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(255, 215, 0, 0.5);
      background: linear-gradient(120deg, #ffe135 0%, #fff066 100%);
    }
    
    .vocabulary-highlight:focus {
      outline: 3px solid var(--info);
      outline-offset: 2px;
    }

    .comprehension-section {
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin: 2rem 0;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .comprehension-title {
      color: var(--info);
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .comprehension-questions {
      display: grid;
      gap: 1rem;
    }
    
    .question-card {
      background: rgba(255,255,255,0.7);
      padding: 1rem;
      border-radius: var(--border-radius);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .question {
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }
    
    .question-type {
      font-size: 0.8rem;
      color: var(--info);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .reading-tips {
      background: rgba(16, 185, 129, 0.1);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--success);
    }
    
    .reading-tips-title {
      color: var(--success);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .loading{
      font-size:1.2rem;
      color:var(--brand-1);
      text-align: center;
      padding: 3rem 1rem;
      font-weight: 600;
    }
    
    .loading::after {
      content: '✨';
      display: inline-block;
      animation: sparkle 1.2s ease-in-out infinite alternate;
      margin-left: 0.5rem;
    }
    
    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); opacity: 0.7; }
      100% { transform: scale(1.3) rotate(180deg); opacity: 1; }
    }
    
    .site-footer{
      padding:2rem 1rem;
      text-align:center;
      color:var(--muted);
      font-size: 0.9rem;
      border-top: 1px solid rgba(147,112,219,0.1);
      margin-top: 2rem;
    }

    .tts-status {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--brand-2);
      color: white;
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 250px;
      text-align: center;
    }
    
    .tts-status.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .tts-status.success {
      background: var(--success);
    }
    
    .tts-status.warning {
      background: var(--warning);
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    @media (prefers-reduced-motion: reduce){ 
      *{animation:none!important;transition:none!important;transform:none!important} 
      .chip:hover, .chip:focus { transform: none; }
      .story-text .word:hover, .story-text .word:focus { transform: none; }
      .brand-img:hover, .story-image:hover { transform: none; }
    }
    
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) {
      .chip:hover::before { opacity: 0; }
      .story-text .word:hover { background: transparent; color: inherit; transform: none; }
    }
    
    /* iPad specific improvements */
    @media (min-width: 768px) and (max-width: 1024px) {
      .app { padding: 0 2rem 2rem; }
      .panel { padding: 2rem; }
      .grid { grid-template-columns: repeat(2, 1fr); }
      .story-text { font-size: 1.5rem; }
    }
    
    /* Large tablet and desktop */
    @media (min-width: 1025px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#content">Skip to story</a>
  <header class="site-header">
    <img src="https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=200&fit=crop&crop=center&q=80" class="brand-img" alt="Magical unicorn with rainbow and sparkles" />
    <h1>Magical Reading Adventures</h1>
    <p class="tagline">Research-based stories that build comprehension skills!</p>
  </header>

  <main id="app" class="app" role="main">
    <section id="age-selection" aria-label="Choose reader" class="panel">
      <h2 class="panel-title">Who's ready for an adventure?</h2>
      <div class="grid" role="list">
        <button class="chip" data-age="evie" role="listitem">
          <span class="age-indicator" aria-hidden="true">🌸</span>
          Evie (Age 4)<br><small style="opacity:0.8;">Simple stories read aloud automatically</small>
        </button>
        <button class="chip" data-age="annabella" role="listitem">
          <span class="age-indicator" aria-hidden="true">✨</span>
          Annabella (Ages 7–8)<br><small style="opacity:0.8;">Enhanced comprehension & vocabulary</small>
        </button>
      </div>
    </section>

    <nav id="topics" class="panel hidden" aria-label="Choose a topic">
      <div class="breadcrumb">
        <span id="reader-name"></span> → Choose Topic
      </div>
      <h2 class="panel-title">Pick your adventure</h2>
      <div id="topic-grid" class="grid" role="list"></div>
      <button class="link" id="back-to-ages">← Back to readers</button>
    </nav>

    <section id="content" class="panel hidden" aria-live="polite">
      <div class="breadcrumb">
        <span id="story-breadcrumb"></span>
      </div>
      <div class="story-controls">
        <button id="tts-play" aria-label="Read story aloud">▶</button>
        <button id="tts-pause" aria-label="Pause reading" disabled>⏸</button>
        <button id="tts-stop" aria-label="Stop reading" disabled>⏹</button>
        <div id="auto-play-indicator" class="auto-play-indicator hidden">
          🔊 Auto-play ON
        </div>
        <label class="slider">
          Speed 
          <input id="tts-rate" type="range" min="0.6" max="1.2" step="0.1" aria-label="Reading speed" />
        </label>
      </div>
      
      <div id="reading-tips" class="reading-tips hidden">
        <div class="reading-tips-title">💡 Reading Tips for Parents</div>
        <div id="reading-tips-content"></div>
      </div>
      
      <figure class="story-figure">
        <div class="image-loading hidden" id="image-loading">Loading magical image...</div>
        <img id="story-image" alt="" class="story-image hidden" />
        <figcaption id="story-caption" class="sr-only"></figcaption>
      </figure>
      <div id="story-text" class="story-text"></div>
      
      <div id="comprehension-section" class="comprehension-section hidden">
        <div class="comprehension-title">🧠 Think & Discuss</div>
        <div id="comprehension-questions" class="comprehension-questions"></div>
      </div>
      
      <div id="loading" class="loading hidden" role="status" aria-live="polite">Crafting your story with research magic…</div>
      <button class="link" id="back-to-topics">← Back to topics</button>
    </section>
  </main>

  <footer class="site-footer">
    <small>Research-based learning adventures for Evie & Annabella ✨ © 2025</small>
  </footer>

  <div id="tts-status" class="tts-status" role="status" aria-live="polite"></div>

  <script>
  // Enhanced Research-Based Stories - Complete Collection
  const STORIES = {
    evie: {
      Unicorns: {
        text: "Pink unicorn, pink unicorn, what do you see? I see a shiny horn sparkling at me. Jump jump, run run, fun fun! Say it with me: <b>u-ni-corn</b>. What rhymes with horn? (Try: corn!) Let's read it again together!",
        imageUrl: "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=600&h=400&fit=crop&crop=center&q=80"
      },
      Dolls: {
        text: "Doll doll, pretty doll, with hair so long. Dress is purple, sing a song. Smile smile, play play, all day! Sound it out: <b>d-o-ll</b>. What color is your doll's dress? Let's imagine and read more!",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center&q=80"
      },
      'Toy Babies': {
        text: "Baby baby, cute cute, with bottle small. Laugh laugh, hug hug, love all! Sleep sleep, dream dream, sweet! Phonics fun: <b>b-a-by</b>. How do you care for a baby? Read and think!",
        imageUrl: "https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=600&h=400&fit=crop&crop=center"
      },
      'Colors & Shapes': {
        text: "Red red circle, round and bright. Blue blue square, what a sight! Yellow star, twinkle twinkle. Colors shapes, fun to mingle! Say: <b>red</b>, <b>blue</b>. What shape is a ball? Let's find out!",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center"
      },
      'Cute Animals': {
        text: "Cat cat, meow meow, soft and fluffy. Dog dog, woof woof, so puffy! Bird bird, tweet tweet, fly high. Animals cute, oh my my! <b>C-a-t</b>, repeat! What animal says quack? Read on!",
        imageUrl: "https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=600&h=400&fit=crop&crop=center"
      },
      'Fairy Friends': {
        text: "Fairy fairy, wings wings, sparkle bright. Fly fly, magic magic, day and night. Friend friend, play play, delight! <b>F-a-i-ry</b>, say it right. Who is your fairy friend? Let's story time!",
        imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=600&h=400&fit=crop&crop=center"
      },
      'Magic Toys': {
        text: "Toy toy, magic magic, bounce so high. Train train, choo choo, zoom by! Ball ball, roll roll, oh my! <b>M-a-gic</b>, try! What magic toy do you have? Read and dream!",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center"
      },
      'Happy Family': {
        text: "Mom mom, dad dad, hug hug tight. Sister sister, brother brother, light light bright. Family family, love love, right! <b>F-a-m-i-ly</b>, sight! What makes your family happy? Share and read!",
        imageUrl: "https://images.unsplash.com/photo-1511895426328-dc8714191300?w=600&h=400&fit=crop&crop=center"
      }
    },
    annabella: {
      'Unicorn Legends': {
        text: "Long ago, people told legends about unicorns with magical healing powers. In ancient China, a unicorn called a 'qilin' was said to appear when a wise ruler was born. European stories described unicorns that could purify poisoned water with their horns. Some legends claimed only people with pure hearts could approach these mystical creatures. Today, we know these are myths, but they teach us about hope and goodness. What makes a legend different from a regular story? Legends often explain something mysterious or teach important values like kindness and bravery. Many cultures around the world have their own unicorn-like creatures in their folklore.",
        imageUrl: "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=600&h=400&fit=crop&crop=center&q=80",
        vocabulary: {
          'legends': 'Stories passed down through generations, often about heroes or magical events',
          'values': 'Important beliefs about what is right and good',
          'mystical': 'Having a spiritual or magical meaning that is difficult to understand',
          'folklore': 'Traditional stories and beliefs of a culture'
        },
        comprehension: [
          {
            type: 'Connection',
            question: 'How do the unicorn legends from China and Europe compare? What do they have in common?'
          },
          {
            type: 'Inference',
            question: 'Why do you think many cultures created stories about magical creatures like unicorns?'
          },
          {
            type: 'Vocabulary',
            question: 'The text mentions "values." What values do unicorn legends teach us?'
          }
        ],
        readingTips: 'Ask your child to make connections to other legends or fairy tales they know. Encourage them to predict what might happen next in stories.'
      },
      'Doll Adventures': {
        text: "Dolls aren't just toys—they can inspire big adventures! Picture a doll sailing across oceans, discovering hidden treasures, and making allies. Educational tip: Playing with dolls builds empathy and storytelling skills. What adventure would your doll have? Throughout history, dolls have been found in ancient Egyptian tombs and Greek temples. They help children practice caring for others and develop imagination. Modern dolls come from many cultures, teaching us about diversity. Some dolls are designed to look like real people, while others are fantasy characters that spark creativity.",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center&q=80",
        vocabulary: {
          'empathy': 'Understanding and sharing the feelings of others',
          'allies': 'Friends who help and support you',
          'diversity': 'Having many different kinds of people and things',
          'creativity': 'The ability to make new and interesting things'
        },
        comprehension: [
          {
            type: 'Main Idea',
            question: 'What is the main message about how dolls help children learn and grow?'
          },
          {
            type: 'Historical Connection',
            question: 'How do ancient dolls connect to modern dolls? What stayed the same?'
          },
          {
            type: 'Personal Application',
            question: 'What adventure story could you create with a doll as the main character?'
          }
        ],
        readingTips: 'Encourage your child to create stories with their toys. Ask them to describe the characters and adventures in detail.'
      },
      'Toy Baby Care': {
        text: "Caring for toy babies teaches real-life skills like feeding, bathing, and comforting. In reality, babies grow from newborns to toddlers, learning to walk around 1 year old. Fact: Responsibility helps kids become independent. How does baby care change as they grow? Real babies need different things at different ages. Newborns sleep most of the day, but toddlers are very active! Playing with baby dolls helps children understand patience and gentleness. It also prepares them for helping with real babies in their families.",
        imageUrl: "https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'responsibility': 'Taking care of important tasks and duties',
          'independent': 'Being able to do things by yourself',
          'patience': 'Being calm and waiting without getting upset',
          'gentleness': 'Being soft and careful with others'
        },
        comprehension: [
          {
            type: 'Sequence',
            question: 'How do babies change as they grow from newborns to toddlers?'
          },
          {
            type: 'Skills Development',
            question: 'What life skills does caring for toy babies teach children?'
          },
          {
            type: 'Real-World Connection',
            question: 'How might playing with baby dolls help you in real life?'
          }
        ],
        readingTips: 'Connect doll play to real family experiences. Ask your child about how they would help care for a real baby.'
      },
      'Ocean Explorers': {
        text: "The ocean covers more than 70% of Earth's surface, yet we've only explored about 5% of it! Marine biologists are scientists who study ocean life. They use special submarines called submersibles to dive deep underwater. The deepest part of the ocean, the Mariana Trench, is nearly seven miles down—that's deeper than Mount Everest is tall! In the dark depths, amazing creatures create their own light through bioluminescence. Some jellyfish glow blue, while certain fish have lights like tiny flashlights. Ocean explorers have discovered species of fish that live near underwater volcanoes. These extreme environments help us understand how life might exist on other planets!",
        imageUrl: "https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'marine biologists': 'Scientists who study ocean life and sea creatures',
          'bioluminescence': 'The ability of living things to create their own light',
          'species': 'A group of similar animals or plants that can have babies together',
          'extreme environments': 'Places with very harsh conditions where few things can survive'
        },
        comprehension: [
          {
            type: 'Main Idea',
            question: 'What is the main idea of this passage about ocean exploration?'
          },
          {
            type: 'Compare/Contrast',
            question: 'How is the deepest part of the ocean similar to the height of Mount Everest?'
          },
          {
            type: 'Prediction',
            question: 'Based on what you read, what do you think ocean explorers might discover next?'
          }
        ],
        readingTips: 'Help your child visualize the ocean depths by comparing them to familiar landmarks. Encourage questions about how sea creatures adapt to their environment.'
      },
      'Space Adventures': {
        text: "Astronauts train for years before traveling to space. They practice in giant pools underwater to simulate the feeling of weightlessness. The International Space Station orbits Earth every 90 minutes, traveling at 17,500 miles per hour! Up there, astronauts conduct experiments that help us understand how plants grow without gravity. They also study how human bodies change in space. Did you know that astronauts actually grow taller in space because their spines stretch out? Mars is our next big destination—it takes about 7 months to travel there. Scientists are working on growing food in space and creating sustainable living areas for future Mars explorers. One day, you might be able to vacation in space!",
        imageUrl: "https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'weightlessness': 'The feeling of floating when there is no gravity pulling you down',
          'experiments': 'Tests that scientists do to learn new things',
          'destination': 'The place you are trying to get to',
          'sustainable': 'Something that can continue for a long time without causing harm'
        },
        comprehension: [
          {
            type: 'Sequence',
            question: 'What steps do astronauts take to prepare for space travel?'
          },
          {
            type: 'Cause/Effect',
            question: 'Why do astronauts grow taller in space? What causes this to happen?'
          },
          {
            type: 'Critical Thinking',
            question: 'What challenges might humans face when trying to live on Mars?'
          }
        ],
        readingTips: 'Connect space concepts to your child\'s daily life. Ask them to imagine what they would miss most about Earth if they lived on Mars.'
      },
      'Dinosaur Friends': {
        text: "Dinosaurs like Velociraptors were smart hunters, while Brachiosaurus ate plants from tall trees. Fossils show they lived 65 million years ago. Fact: Birds are modern dinosaur relatives. If dinosaurs were friends, what games would they play? Scientists called paleontologists study dinosaur bones to learn about these ancient creatures. Some dinosaurs were as small as chickens, while others were longer than school buses! They lived in different time periods and had amazing adaptations. T-Rex had tiny arms but powerful jaws, while Triceratops had three horns for protection.",
        imageUrl: "https://images.unsplash.com/photo-1472491235688-bdc81a63246e?w=600&h=400&fit=crop&crop=center&q=80",
        vocabulary: {
          'fossils': 'Remains of ancient plants and animals preserved in rock',
          'paleontologists': 'Scientists who study fossils and prehistoric life',
          'adaptations': 'Special features that help animals survive in their environment',
          'prehistoric': 'From a very long time ago, before recorded history'
        },
        comprehension: [
          {
            type: 'Compare/Contrast',
            question: 'How were plant-eating dinosaurs different from meat-eating dinosaurs?'
          },
          {
            type: 'Scientific Connection',
            question: 'What evidence do we have that birds are related to dinosaurs?'
          },
          {
            type: 'Imagination',
            question: 'If you could meet a friendly dinosaur, which one would you choose and why?'
          }
        ],
        readingTips: 'Visit a natural history museum to see real fossils. Encourage your child to compare dinosaurs to modern animals.'
      },
      'Science Magic': {
        text: "Science turns everyday things into magic, like making volcanoes with baking soda and vinegar—it's an acid-base reaction creating CO2 gas. Fact: This teaches chemistry basics. What 'magic' experiment can you do at home? Scientists use the scientific method: ask a question, make a hypothesis, test it, and draw conclusions. Many scientific discoveries happened by accident, like penicillin medicine. Every day, we use science without thinking about it—from cooking (chemistry) to riding bikes (physics). Science helps us understand how the world works and solve problems.",
        imageUrl: "https://images.unsplash.com/photo-1532187643603-ba119ca4109e?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'hypothesis': 'An educated guess about what might happen in an experiment',
          'scientific method': 'The step-by-step way scientists investigate questions',
          'chemistry': 'The science that studies how different substances mix and change',
          'physics': 'The science that studies how things move and work'
        },
        comprehension: [
          {
            type: 'Process',
            question: 'What are the steps of the scientific method?'
          },
          {
            type: 'Real-World Application',
            question: 'How do we use science in everyday activities like cooking or playing?'
          },
          {
            type: 'Investigation',
            question: 'What science experiment would you like to try at home?'
          }
        ],
        readingTips: 'Try simple, safe experiments together. Ask your child to predict what will happen before you start.'
      },
      'History Heroes': {
        text: "History heroes like Harriet Tubman led people to freedom via the Underground Railroad. She made 13 missions, saving over 70 people. Fact: Heroes inspire change. Who is your history hero and why? Other heroes include Marie Curie, the first woman to win a Nobel Prize, and Frederick Douglass, who escaped slavery and became a famous speaker for freedom. These brave people changed the world by standing up for what was right, even when it was dangerous. They show us that one person can make a huge difference.",
        imageUrl: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'Underground Railroad': 'A secret network that helped enslaved people escape to freedom',
          'Nobel Prize': 'A special award given to people who make important discoveries',
          'inspire': 'To encourage others to do great things',
          'courage': 'Being brave even when you are scared'
        },
        comprehension: [
          {
            type: 'Character Analysis',
            question: 'What qualities made Harriet Tubman a hero?'
          },
          {
            type: 'Cause/Effect',
            question: 'How did these heroes change the world for the better?'
          },
          {
            type: 'Personal Connection',
            question: 'What would you do to help others if you could be a hero?'
          }
        ],
        readingTips: 'Discuss what makes someone a hero. Encourage your child to think about everyday heroes in their own life.'
      },
      'Nature Detectives': {
        text: "Nature detectives observe how bees pollinate flowers, helping plants grow fruit. Seasons change due to Earth's tilt. Fact: Trees can communicate through underground fungi networks. What nature mystery can you solve? Animals leave clues everywhere—tracks in mud, nests in trees, and sounds in the forest. By watching carefully, we can learn how ecosystems work together. Every living thing has a job in nature, from tiny ants to huge elephants. Even decomposers like mushrooms help by breaking down dead plants to feed the soil.",
        imageUrl: "https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'pollinate': 'When bees carry pollen from flower to flower to help plants make seeds',
          'ecosystems': 'All the living things in an area and how they work together',
          'decomposers': 'Living things that break down dead plants and animals',
          'fungi': 'Mushrooms and other plant-like living things that don\'t make their own food'
        },
        comprehension: [
          {
            type: 'Systems Thinking',
            question: 'How do bees, flowers, and fruit trees work together in nature?'
          },
          {
            type: 'Observation Skills',
            question: 'What clues could you look for to learn about animals in your neighborhood?'
          },
          {
            type: 'Scientific Wonder',
            question: 'What nature mystery would you most like to investigate?'
          }
        ],
        readingTips: 'Go on nature walks and encourage your child to observe and ask questions about what they see.'
      },
      'Ancient Egypt': {
        text: "Ancient Egypt was one of the world's greatest civilizations, lasting over 3,000 years! The Egyptians built amazing pyramids that still stand today. The Great Pyramid of Giza was the world's tallest building for almost 4,000 years. Egyptians created hieroglyphics, a writing system using pictures and symbols. They wrote on papyrus, an early type of paper made from plants. Egyptian pharaohs were kings and queens who were considered gods. The most famous pharaoh, King Tutankhamun, became king when he was only nine years old! Egyptians believed in life after death and mummified bodies to preserve them. Their mathematical and engineering skills were so advanced that we still study them today.",
        imageUrl: "https://images.unsplash.com/photo-1594736797933-d0f06ba80404?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'civilizations': 'Large groups of people living together with their own culture and way of life',
          'hieroglyphics': 'Ancient Egyptian writing using pictures and symbols instead of letters',
          'pharaohs': 'Kings and queens who ruled ancient Egypt',
          'engineering': 'Using science and math to build amazing things'
        },
        comprehension: [
          {
            type: 'Timeline',
            question: 'How long did ancient Egyptian civilization last, and what does this tell us about their success?'
          },
          {
            type: 'Problem/Solution',
            question: 'What problem were the Egyptians trying to solve by mummifying bodies?'
          },
          {
            type: 'Evidence',
            question: 'What evidence from the text shows that ancient Egyptians were skilled builders and engineers?'
          }
        ],
        readingTips: 'Help your child create a timeline of events. Encourage them to compare ancient Egyptian innovations to modern technology.'
      },
      'Animal Adaptations': {
        text: "Adaptation is how animals change over time to survive in their environments. Polar bears have thick white fur to stay warm and hide in Arctic snow. Desert camels store fat in their humps for energy during long journeys without food. Chameleons change colors to camouflage themselves from predators and communicate with other chameleons. Birds have different beak shapes for different foods: long thin beaks for nectar, strong thick beaks for seeds, and sharp curved beaks for hunting. Some animals have behavioral adaptations too—wolves hunt in packs, while meerkats take turns standing guard. Ocean animals show amazing adaptations: whales hold their breath for hours, and deep-sea fish create their own light. These adaptations took millions of years to develop through evolution.",
        imageUrl: "https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=600&h=400&fit=crop&crop=center",
        vocabulary: {
          'adaptation': 'How animals change over time to survive better in their homes',
          'camouflage': 'When animals change colors or patterns to hide from enemies',
          'behavioral adaptations': 'Special things animals do (not how they look) to survive',
          'evolution': 'The very slow process of how animals change over millions of years'
        },
        comprehension: [
          {
            type: 'Categories',
            question: 'What are the differences between physical adaptations and behavioral adaptations?'
          },
          {
            type: 'Analysis',
            question: 'How do a polar bear\'s adaptations specifically help it survive in the Arctic?'
          },
          {
            type: 'Synthesis',
            question: 'If you could design an animal for a specific environment, what adaptations would you give it?'
          }
        ],
        readingTips: 'Ask your child to think about how pets are adapted for their environments. Encourage them to observe animal behaviors at parks or zoos.'
      }
    }
  };

  // App state & DOM elements
  const el = {
    ageSection: document.getElementById('age-selection'),
    topicsPanel: document.getElementById('topics'),
    topicGrid: document.getElementById('topic-grid'),
    backToAges: document.getElementById('back-to-ages'),
    content: document.getElementById('content'),
    img: document.getElementById('story-image'),
    caption: document.getElementById('story-caption'),
    text: document.getElementById('story-text'),
    loading: document.getElementById('loading'),
    imageLoading: document.getElementById('image-loading'),
    ttsPlay: document.getElementById('tts-play'),
    ttsPause: document.getElementById('tts-pause'),
    ttsStop: document.getElementById('tts-stop'),
    ttsRate: document.getElementById('tts-rate'),
    ttsStatus: document.getElementById('tts-status'),
    readerName: document.getElementById('reader-name'),
    storyBreadcrumb: document.getElementById('story-breadcrumb'),
    autoPlayIndicator: document.getElementById('auto-play-indicator'),
    comprehensionSection: document.getElementById('comprehension-section'),
    comprehensionQuestions: document.getElementById('comprehension-questions'),
    readingTips: document.getElementById('reading-tips'),
    readingTipsContent: document.getElementById('reading-tips-content')
  };

  let state = {
    ageKey: null,
    subject: null,
    voice: null,
    rate: parseFloat(localStorage.getItem('tts-rate') || '0.8'),
    isReading: false,
    currentUtterance: null,
    autoPlay: false
  };

  // Initialize rate slider
  el.ttsRate.value = state.rate;

  // Enhanced Voice Selection
  const synth = window.speechSynthesis;
  let voicesLoaded = false;

  function loadVoices() {
    if (voicesLoaded) return;
    
    const voices = synth.getVoices();
    if (voices.length === 0) return;
    
    voicesLoaded = true;
    
    // Prioritize child-friendly voices
    const childFriendlyVoices = [
      'Microsoft Zira', 'Google US English Female', 'Samantha', 'Victoria', 
      'Karen', 'Google UK English Female', 'Susan', 'Alex', 'Daniel'
    ];
    
    let bestVoice = null;
    
    for (let preferred of childFriendlyVoices) {
      bestVoice = voices.find(v => v.name.includes(preferred));
      if (bestVoice) break;
    }
    
    if (!bestVoice) {
      bestVoice = voices.find(v => 
        v.lang.startsWith('en') && (v.localService || v.default)
      ) || voices.find(v => v.lang.startsWith('en')) || voices[0];
    }
    
    state.voice = bestVoice;
    console.log('Selected voice:', bestVoice?.name || 'None available');
  }

  synth.onvoiceschanged = loadVoices;
  loadVoices();

  // Event Listeners
  document.addEventListener('DOMContentLoaded', initializeApp);
  if (document.readyState !== 'loading') {
    initializeApp();
  }

  function initializeApp() {
    // Age selection
    document.querySelectorAll('.chip[data-age]').forEach(btn => {
      btn.addEventListener('click', () => {
        state.ageKey = btn.dataset.age;
        state.autoPlay = (state.ageKey === 'evie');
        showTopics(state.ageKey);
      });
    });

    // Navigation
    el.backToAges.addEventListener('click', () => {
      stopTTS();
      el.topicsPanel.classList.add('hidden');
      el.content.classList.add('hidden');
      el.ageSection.classList.remove('hidden');
      el.topicGrid.innerHTML = '';
      state.ageKey = null;
      state.autoPlay = false;
    });

    document.getElementById('back-to-topics').addEventListener('click', () => {
      stopTTS();
      el.content.classList.add('hidden');
      el.topicsPanel.classList.remove('hidden');
    });

    // TTS Controls
    el.ttsPlay.addEventListener('click', () => {
      if (synth.paused) {
        resumeTTS();
      } else {
        const text = getPlainTextFromStory();
        if (text) speak(text);
      }
    });

    el.ttsPause.addEventListener('click', pauseTTS);
    el.ttsStop.addEventListener('click', stopTTS);

    el.ttsRate.addEventListener('input', (e) => {
      state.rate = parseFloat(e.target.value);
      localStorage.setItem('tts-rate', state.rate.toString());
      showTTSStatus(`Speed: ${Math.round(state.rate * 100)}%`, 1000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        stopTTS();
      } else if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        if (state.isReading) {
          if (synth.paused) resumeTTS();
          else pauseTTS();
        } else {
          const text = getPlainTextFromStory();
          if (text) speak(text);
        }
      }
    });

    // Cleanup
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        stopTTS();
      }
    });

    window.addEventListener('beforeunload', stopTTS);

    console.log('App initialized');
  }

  function showTopics(ageKey) {
    el.ageSection.classList.add('hidden');
    el.topicsPanel.classList.remove('hidden');
    el.topicGrid.innerHTML = '';
    
    const readerName = ageKey === 'evie' ? '🌸 Evie' : '✨ Annabella';
    el.readerName.textContent = readerName;
    
    const topics = Object.keys(STORIES[ageKey] || {});
    
    topics.forEach(name => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = name;
      b.addEventListener('click', () => loadStory(ageKey, name));
      el.topicGrid.appendChild(b);
    });
  }

  async function loadStory(ageKey, subject) {
    stopTTS();
    state.subject = subject;
    
    el.loading.classList.remove('hidden');
    el.topicsPanel.classList.add('hidden');
    el.content.classList.remove('hidden');
    
    el.text.innerHTML = '';
    el.img.classList.add('hidden');
    el.imageLoading.classList.remove('hidden');
    el.comprehensionSection.classList.add('hidden');
    el.readingTips.classList.add('hidden');
    
    const readerName = ageKey === 'evie' ? '🌸 Evie' : '✨ Annabella';
    el.storyBreadcrumb.textContent = `${readerName} → ${subject}`;
    
    if (state.autoPlay) {
      el.autoPlayIndicator.classList.remove('hidden');
    } else {
      el.autoPlayIndicator.classList.add('hidden');
    }
    
    try {
      await new Promise(r => setTimeout(r, 600));
      const data = STORIES[ageKey]?.[subject];
      if (!data) throw new Error('No story found');

      processAndRenderStory(data, ageKey);
      
      if (data.imageUrl) {
        loadStoryImage(data.imageUrl, subject);
      } else {
        el.imageLoading.classList.add('hidden');
      }
      
      if (ageKey === 'annabella') {
        if (data.comprehension) {
          showComprehensionQuestions(data.comprehension);
        }
        if (data.readingTips) {
          showReadingTips(data.readingTips);
        }
      }
      
      if (state.autoPlay && state.ageKey === 'evie') {
        setTimeout(() => {
          const text = getPlainTextFromStory();
          if (text) {
            showTTSStatus('✨ Starting story for Evie!', 2000);
            speak(text);
          }
        }, 800);
      } else if (state.ageKey === 'annabella') {
        showTTSStatus('📖 Story ready! Read first, then explore questions below', 3000);
      }
      
    } catch (err) {
      console.error('Story loading error:', err);
      el.text.textContent = `Oops! Magic mishap. Try again. (${err.message})`;
      showTTSStatus('Story loading failed', 3000, 'warning');
    } finally {
      el.loading.classList.add('hidden');
    }
  }

  function processAndRenderStory(data, ageKey) {
    let processedText = data.text;
    
    // Apply vocabulary highlighting for Annabella
    if (ageKey === 'annabella' && data.vocabulary) {
      Object.keys(data.vocabulary).forEach(word => {
        const regex = new RegExp(`\\b(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})\\b`, 'gi');
        processedText = processedText.replace(regex, `<span class="vocabulary-highlight">$1</span>`);
      });
    }
    
    // Create clickable word spans
    const segments = processedText.split(/(<[^>]*>)/);
    let result = '';
    
    for (let i = 0; i < segments.length; i++) {
      const segment = segments[i];
      
      if (segment.startsWith('<') && segment.endsWith('>')) {
        result += segment;
      } else if (segment.trim()) {
        const words = segment.split(/(\s+)/).map(part => {
          if (part.trim()) {
            return `<span class="word" tabindex="0" role="button">${part}</span>`;
          }
          return part;
        }).join('');
        result += words;
      } else {
        result += segment;
      }
    }

    el.text.innerHTML = result;
    
    addWordEventListeners();
    if (ageKey === 'annabella' && data.vocabulary) {
      addVocabularyHandlers(data.vocabulary);
    }
  }

  function addWordEventListeners() {
    const wordElements = document.querySelectorAll('.word');
    wordElements.forEach(el => {
      el.addEventListener('click', () => {
        const vocabChild = el.querySelector('.vocabulary-highlight');
        if (!vocabChild) {
          speakWord(el.textContent);
        }
      });
      
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const vocabChild = el.querySelector('.vocabulary-highlight');
          if (!vocabChild) {
            speakWord(el.textContent);
          }
        }
      });
    });
  }

  function addVocabularyHandlers(vocabularyDict) {
    const vocabElements = document.querySelectorAll('.vocabulary-highlight');
    vocabElements.forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        const word = el.textContent.trim().toLowerCase();
        const definition = vocabularyDict[word];
        if (definition) {
          showVocabularyDefinition(word, definition);
          speakVocabularyWord(word, definition);
        }
      });
      
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          e.stopPropagation();
          const word = el.textContent.trim().toLowerCase();
          const definition = vocabularyDict[word];
          if (definition) {
            showVocabularyDefinition(word, definition);
            speakVocabularyWord(word, definition);
          }
        }
      });
      
      el.setAttribute('tabindex', '0');
      el.setAttribute('role', 'button');
      el.setAttribute('aria-label', `Learn about: ${el.textContent}`);
    });
  }

  function loadStoryImage(imageUrl, subject) {
    const img = new Image();
    img.onload = () => {
      el.img.src = imageUrl;
      el.img.alt = `${subject} illustration - a beautiful scene showing ${subject.toLowerCase()}`;
      el.img.classList.remove('hidden');
      el.imageLoading.classList.add('hidden');
      el.caption.textContent = subject;
    };
    img.onerror = () => {
      el.imageLoading.textContent = 'Image unavailable';
      setTimeout(() => el.imageLoading.classList.add('hidden'), 2000);
    };
    img.src = imageUrl;
  }

  function showComprehensionQuestions(questions) {
    el.comprehensionQuestions.innerHTML = '';
    questions.forEach(q => {
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.innerHTML = `
        <div class="question-type">${q.type}</div>
        <div class="question">${q.question}</div>
      `;
      el.comprehensionQuestions.appendChild(questionCard);
    });
    el.comprehensionSection.classList.remove('hidden');
  }

  function showReadingTips(tips) {
    el.readingTipsContent.textContent = tips;
    el.readingTips.classList.remove('hidden');
  }

  function getPlainTextFromStory() {
    return el.text.textContent || '';
  }

  function showVocabularyDefinition(word, definition) {
    showTTSStatus(`📚 ${word.charAt(0).toUpperCase() + word.slice(1)}: ${definition}`, 4000, 'success');
  }

  function speakVocabularyWord(word, definition) {
    const text = `${word}. ${definition}`;
    speakWord(text);
  }

  // TTS Functions
  function updateTTSButtons(isPlaying, isPaused = false) {
    el.ttsPlay.disabled = isPlaying && !isPaused;
    el.ttsPause.disabled = !isPlaying;
    el.ttsStop.disabled = !isPlaying;
    
    el.ttsPlay.classList.toggle('playing', isPlaying && !isPaused);
    
    if (isPlaying && !isPaused) {
      el.ttsPlay.setAttribute('aria-label', 'Reading...');
    } else {
      el.ttsPlay.setAttribute('aria-label', 'Read story aloud');
    }
  }

  function showTTSStatus(message, duration = 2000, type = 'default') {
    el.ttsStatus.textContent = message;
    el.ttsStatus.className = `tts-status ${type} show`;
    if (duration > 0) {
      setTimeout(() => {
        el.ttsStatus.classList.remove('show');
      }, duration);
    }
  }

  function speak(text) {
    if (!text || !text.trim()) return;
    
    stopTTS();
    
    const cleanText = text.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    if (!cleanText) return;
    
    const utterance = new SpeechSynthesisUtterance(cleanText);
    state.currentUtterance = utterance;
    
    if (state.voice) {
      utterance.voice = state.voice;
    }
    utterance.lang = 'en-US';
    
    if (state.ageKey === 'evie') {
      utterance.rate = Math.min(state.rate, 0.8);
      utterance.pitch = 1.3;
      utterance.volume = 0.9;
    } else {
      utterance.rate = Math.max(Math.min(state.rate, 1.1), 0.7);
      utterance.pitch = 1.1;
      utterance.volume = 0.85;
    }
    
    utterance.onstart = () => {
      state.isReading = true;
      updateTTSButtons(true);
      const readerName = state.ageKey === 'evie' ? 'Evie' : 'Annabella';
      showTTSStatus(`📖 Reading for ${readerName}...`, 0);
    };
    
    utterance.onend = () => {
      state.isReading = false;
      state.currentUtterance = null;
      updateTTSButtons(false);
      showTTSStatus('✅ Story complete!', 2000, 'success');
    };
    
    utterance.onerror = (event) => {
      console.error('Speech synthesis error:', event.error);
      state.isReading = false;
      state.currentUtterance = null;
      updateTTSButtons(false);
      showTTSStatus('❌ Speech error occurred', 3000, 'warning');
    };
    
    synth.speak(utterance);
  }

  function speakWord(word) {
    if (!word || !word.trim()) return;
    
    const cleanWord = word.replace(/<[^>]*>/g, '').trim();
    if (!cleanWord) return;
    
    const utterance = new SpeechSynthesisUtterance(cleanWord);
    
    if (state.voice) {
      utterance.voice = state.voice;
    }
    utterance.lang = 'en-US';
    utterance.rate = state.ageKey === 'evie' ? 0.7 : 0.8;
    utterance.pitch = state.ageKey === 'evie' ? 1.4 : 1.2;
    utterance.volume = 0.8;
    
    const wordElements = document.querySelectorAll('.word');
    wordElements.forEach(el => {
      if (el.textContent.trim() === cleanWord) {
        el.classList.add('speaking');
        setTimeout(() => el.classList.remove('speaking'), 500);
      }
    });
    
    synth.speak(utterance);
  }

  function pauseTTS() {
    if (synth.speaking && !synth.paused) {
      synth.pause();
      updateTTSButtons(true, true);
      showTTSStatus('⏸ Reading paused', 1500, 'warning');
    }
  }

  function resumeTTS() {
    if (synth.paused) {
      synth.resume();
      updateTTSButtons(true, false);
      showTTSStatus('▶ Resumed reading', 1500);
    }
  }

  function stopTTS() {
    if (synth.speaking || synth.paused) {
      if (synth.paused) synth.resume();
      synth.cancel();
    }
    state.isReading = false;
    state.currentUtterance = null;
    updateTTSButtons(false);
  }

  // Initialize TTS buttons
  updateTTSButtons(false);
  </script>
</body>
</html>
