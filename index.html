<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Magical Reading Adventures ‚Äî Enhanced v4</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #fff7fb;
      --ink: #2c2152;
      --muted: #6d5db3;
      --brand-1: #ff69b4;
      --brand-2: #9370db;
      --brand-3: #ffd1dc;
      --card: #ffffffee;
      --focus: #222;
      --shadow: 0 8px 20px rgba(147,112,219,.2);
      --shadow-light: 0 4px 12px rgba(147,112,219,.15);
      --border-radius: 1rem;
      --border-radius-lg: 1.25rem;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    
    @media (prefers-color-scheme: dark){
      :root{ 
        --bg:#15121c; 
        --ink:#f7f3ff; 
        --muted:#c8bfff; 
        --card:#1f1a2bee;
        --shadow: 0 8px 20px rgba(0,0,0,.4);
        --shadow-light: 0 4px 12px rgba(0,0,0,.3);
      }
    }
    
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html,body{
      height:100%;
      overflow-x: hidden;
    }
    
    body{
      margin:0;
      font-family:"Baloo 2", system-ui, -apple-system, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(60% 60% at 20% 10%, rgba(255,105,180,.25), transparent 60%),
        radial-gradient(50% 50% at 80% 0%, rgba(147,112,219,.25), transparent 60%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .skip-link{
      position:absolute;
      left:-9999px;
      top:auto;
    }
    .skip-link:focus{
      left:1rem;
      top:1rem;
      background:#fff;
      color:#000;
      padding:.75rem 1rem;
      border-radius:var(--border-radius);
      z-index: 1000;
    }

    .site-header{
      padding:1.5rem 1rem 1rem;
      text-align:center;
      position: relative;
    }
    
    .brand-img{
      width:min(240px, 80vw);
      height:auto;
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      transition: transform 0.3s ease;
    }
    
    .brand-img:hover {
      transform: scale(1.02);
    }
    
    h1{
      margin:.75rem 0 0;
      font-size: clamp(1.75rem, 5vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .tagline{
      color:var(--muted);
      font-size: clamp(1rem, 3vw, 1.1rem);
      margin: 0.5rem 0;
      font-weight: 500;
    }

    .app{
      max-width:1000px;
      margin:0 auto;
      padding:0 1rem 2rem;
    }
    
    .panel{
      background:var(--card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      border-radius:var(--border-radius-lg);
      padding:1.5rem;
      margin:1rem 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-title{
      margin:.25rem 0 1.25rem;
      font-size: clamp(1.25rem, 4vw, 1.5rem);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .age-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }

    .grid{
      display:grid;
      gap:1rem;
      grid-template-columns:repeat(auto-fit,minmax(min(250px, 100%), 1fr));
    }
    
    @media (max-width: 600px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }
    
    .chip{
      font-size:clamp(1.1rem, 3.5vw, 1.25rem);
      font-weight: 600;
      padding:1.25rem 1.5rem;
      border:0;
      cursor:pointer;
      border-radius:var(--border-radius);
      background:linear-gradient(135deg,var(--brand-3), var(--brand-1));
      color:#3a0a4b; 
      box-shadow:var(--shadow-light); 
      min-height:68px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .chip::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.15);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .chip:hover::before,
    .chip:focus::before {
      opacity: 1;
    }
    
    .chip:focus,.chip:hover{
      outline:3px solid var(--focus);
      outline-offset:3px;
      transform:translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .chip:active {
      transform: translateY(0);
    }

    .link{
      background:none;
      border:none;
      color:var(--brand-2);
      cursor:pointer;
      font-size:1.1rem;
      font-weight: 600;
      margin-top:1rem;
      padding: 0.75rem 0;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .link:focus{
      outline:3px solid var(--focus);
      outline-offset:3px;
    }
    .link:hover {
      color: var(--brand-1);
      transform: translateX(-2px);
    }

    .story-controls{
      display:flex;
      gap:.75rem;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 1.5rem;
      padding: 1.25rem;
      background: rgba(255,255,255,0.1);
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .story-controls button{
      width:56px;
      height:56px;
      border-radius:var(--border-radius);
      border:0;
      background:var(--brand-2);
      color:#fff;
      cursor:pointer;
      box-shadow:var(--shadow-light);
      font-size: 1.3rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .story-controls button:focus{
      outline:3px solid var(--focus);
      outline-offset:3px;
    }
    
    .story-controls button:hover:not(:disabled) {
      background: var(--brand-1);
      transform: translateY(-1px);
    }
    
    .story-controls button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .story-controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      background: var(--muted);
    }
    
    .story-controls button.playing {
      background: var(--success);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .auto-play-indicator {
      background: var(--warning);
      color: white;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .slider{
      display:flex;
      align-items:center;
      gap:.75rem;
      color:var(--muted);
      font-weight: 600;
      margin-left: auto;
    }
    
    .slider input {
      width: 90px;
      accent-color: var(--brand-2);
    }
    
    @media (max-width: 600px) {
      .story-controls {
        justify-content: center;
      }
      .slider, .auto-play-indicator {
        margin-left: 0;
        margin-top: 0.75rem;
      }
    }

    .story-figure{
      margin:1.5rem 0;
      text-align: center;
      position: relative;
    }
    
    .story-image{
      width:100%;
      max-width: 600px;
      height:auto;
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      transition: transform 0.3s ease;
    }
    
    .story-image:hover {
      transform: scale(1.02);
    }
    
    .image-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 1rem;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      color: var(--muted);
    }
    
    .hidden{display:none}

    .story-text{
      font-size:clamp(1.2rem, 4vw, 1.4rem);
      line-height:1.8;
      margin-bottom: 2rem;
    }
    
    .story-text .word{
      padding:0.25rem 0.35rem;
      border-radius:0.5rem;
      cursor:pointer;
      transition: all 0.2s ease;
      display: inline-block;
      margin: 0.1rem;
      position: relative;
    }
    
    .story-text .word:hover,
    .story-text .word:focus{
      background:var(--brand-1);
      color:#fff;
      transform: scale(1.05);
      z-index: 1;
    }
    
    .story-text .word:active {
      transform: scale(0.95);
    }
    
    .story-text .word.speaking {
      background: var(--success);
      color: white;
      animation: highlight 0.5s ease;
    }
    
    @keyframes highlight {
      0% { background: var(--warning); }
      100% { background: var(--success); }
    }

    .comprehension-section {
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin: 2rem 0;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .comprehension-title {
      color: var(--info);
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .comprehension-questions {
      display: grid;
      gap: 1rem;
    }
    
    .question-card {
      background: rgba(255,255,255,0.7);
      padding: 1rem;
      border-radius: var(--border-radius);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .question {
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }
    
    .question-type {
      font-size: 0.8rem;
      color: var(--info);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .vocabulary-highlight {
      background: linear-gradient(120deg, var(--warning) 0%, var(--warning) 100%);
      background-repeat: no-repeat;
      background-size: 100% 0.2em;
      background-position: 0 88%;
      font-weight: 600;
      padding: 0.1rem 0.2rem;
      border-radius: 0.25rem;
    }

    .reading-tips {
      background: rgba(16, 185, 129, 0.1);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--success);
    }
    
    .reading-tips-title {
      color: var(--success);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .loading{
      font-size:1.2rem;
      color:var(--brand-1);
      text-align: center;
      padding: 3rem 1rem;
      font-weight: 600;
    }
    
    .loading::after {
      content: '‚ú®';
      display: inline-block;
      animation: sparkle 1.2s ease-in-out infinite alternate;
      margin-left: 0.5rem;
    }
    
    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); opacity: 0.7; }
      100% { transform: scale(1.3) rotate(180deg); opacity: 1; }
    }
    
    .site-footer{
      padding:2rem 1rem;
      text-align:center;
      color:var(--muted);
      font-size: 0.9rem;
      border-top: 1px solid rgba(147,112,219,0.1);
      margin-top: 2rem;
    }

    .tts-status {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--brand-2);
      color: white;
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s ease;
      z-index: 1000;
      max-width: 250px;
      text-align: center;
    }
    
    .tts-status.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .tts-status.success {
      background: var(--success);
    }
    
    .tts-status.warning {
      background: var(--warning);
    }

    /* Voice Settings Modal */
    .voice-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      backdrop-filter: blur(5px);
    }
    
    .voice-modal.hidden {
      display: none;
    }
    
    .voice-modal-content {
      background: var(--card);
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .voice-modal-content h3 {
      margin: 0 0 1.5rem 0;
      font-size: 1.5rem;
      color: var(--ink);
      text-align: center;
    }
    
    .voice-option {
      margin: 1rem 0;
      padding: 1rem;
      border: 2px solid transparent;
      border-radius: var(--border-radius);
      background: rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    
    .voice-option:has(input:checked) {
      border-color: var(--brand-2);
      background: rgba(147,112,219,0.1);
    }
    
    .voice-option label {
      display: block;
      cursor: pointer;
      font-weight: 600;
    }
    
    .voice-label {
      display: block;
      margin-bottom: 0.25rem;
    }
    
    .voice-option small {
      color: var(--muted);
      font-size: 0.85rem;
    }
    
    .elevenlabs-setup {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--border-radius);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .elevenlabs-setup input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--border-radius);
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.9);
    }
    
    .elevenlabs-setup small {
      color: var(--info);
      font-size: 0.8rem;
    }
    
    .elevenlabs-setup a {
      color: var(--info);
      text-decoration: underline;
    }
    
    .voice-modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    
    .voice-save-btn, .voice-close-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .voice-save-btn {
      background: var(--brand-2);
      color: white;
    }
    
    .voice-save-btn:hover {
      background: var(--brand-1);
    }
    
    .voice-close-btn {
      background: var(--muted);
      color: white;
    }
    
    .voice-close-btn:hover {
      background: var(--ink);
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    @media (prefers-reduced-motion: reduce){ 
      *{animation:none!important;transition:none!important;transform:none!important} 
      .chip:hover, .chip:focus { transform: none; }
      .story-text .word:hover, .story-text .word:focus { transform: none; }
      .brand-img:hover, .story-image:hover { transform: none; }
    }
    
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) {
      .chip:hover::before { opacity: 0; }
      .story-text .word:hover { background: transparent; color: inherit; transform: none; }
    }
    
    /* iPad specific improvements */
    @media (min-width: 768px) and (max-width: 1024px) {
      .app { padding: 0 2rem 2rem; }
      .panel { padding: 2rem; }
      .grid { grid-template-columns: repeat(2, 1fr); }
      .story-text { font-size: 1.5rem; }
    }
    
    /* Large tablet and desktop */
    @media (min-width: 1025px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#content">Skip to story</a>
  <header class="site-header">
    <img src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=200&fit=crop&crop=center" class="brand-img" alt="Magical unicorn with rainbow and sparkles" />
    <h1>Magical Reading Adventures</h1>
    <p class="tagline">Research-based stories that build comprehension skills!</p>
  </header>

  <main id="app" class="app" role="main">
    <section id="age-selection" aria-label="Choose reader" class="panel">
      <h2 class="panel-title">Who's ready for an adventure?</h2>
      <div class="grid" role="list">
        <button class="chip" data-age="evie" role="listitem">
          <span class="age-indicator" aria-hidden="true">üå∏</span>
          Evie (Age 4)<br><small style="opacity:0.8;">Simple stories read aloud automatically</small>
        </button>
        <button class="chip" data-age="annabella" role="listitem">
          <span class="age-indicator" aria-hidden="true">‚ú®</span>
          Annabella (Ages 7‚Äì8)<br><small style="opacity:0.8;">Enhanced comprehension & vocabulary</small>
        </button>
      </div>
    </section>

    <nav id="topics" class="panel hidden" aria-label="Choose a topic">
      <div class="breadcrumb">
        <span id="reader-name"></span> ‚Üí Choose Topic
      </div>
      <h2 class="panel-title">Pick your adventure</h2>
      <div id="topic-grid" class="grid" role="list"></div>
      <button class="link" id="back-to-ages">‚Üê Back to readers</button>
    </nav>

    <section id="content" class="panel hidden" aria-live="polite">
      <div class="breadcrumb">
        <span id="story-breadcrumb"></span>
      </div>
      <div class="story-controls">
        <button id="tts-play" aria-label="Read story aloud">‚ñ∂</button>
        <button id="tts-pause" aria-label="Pause reading" disabled>‚è∏</button>
        <button id="tts-stop" aria-label="Stop reading" disabled>‚èπ</button>
        <button id="voice-settings" aria-label="Voice settings">üé§</button>
        <div id="auto-play-indicator" class="auto-play-indicator hidden">
          üîä Auto-play ON
        </div>
        <label class="slider">
          Speed 
          <input id="tts-rate" type="range" min="0.6" max="1.2" step="0.1" aria-label="Reading speed" />
        </label>
      </div>
      
      <div id="reading-tips" class="reading-tips hidden">
        <div class="reading-tips-title">üí° Reading Tips for Parents</div>
        <div id="reading-tips-content"></div>
      </div>
      
      <figure class="story-figure">
        <div class="image-loading hidden" id="image-loading">Loading magical image...</div>
        <img id="story-image" alt="" class="story-image hidden" />
        <figcaption id="story-caption" class="sr-only"></figcaption>
      </figure>
      <div id="story-text" class="story-text"></div>
      
      <div id="comprehension-section" class="comprehension-section hidden">
        <div class="comprehension-title">üß† Think & Discuss</div>
        <div id="comprehension-questions" class="comprehension-questions"></div>
      </div>
      
      <div id="loading" class="loading hidden" role="status" aria-live="polite">Crafting your story with research magic‚Ä¶</div>
      <button class="link" id="back-to-topics">‚Üê Back to topics</button>
    </section>
  </main>

  <footer class="site-footer">
    <small>Research-based learning adventures for Evie & Annabella ‚ú® ¬© 2025</small>
  </footer>

  <div id="tts-status" class="tts-status" role="status" aria-live="polite"></div>

  <!-- Voice Settings Modal -->
  <div id="voice-modal" class="voice-modal hidden">
    <div class="voice-modal-content">
      <h3>üé§ Voice Settings</h3>
      <div class="voice-option">
        <label>
          <input type="radio" name="voice-type" value="browser" checked>
          <span class="voice-label">Browser Voice (Free)</span>
          <small>Uses your device's built-in voices</small>
        </label>
      </div>
      <div class="voice-option">
        <label>
          <input type="radio" name="voice-type" value="elevenlabs">
          <span class="voice-label">ElevenLabs AI Voice (Premium) ‚ú®</span>
          <small>Ultra-realistic, child-friendly voices</small>
        </label>
      </div>
      <div id="elevenlabs-setup" class="elevenlabs-setup hidden">
        <input type="password" id="api-key-input" placeholder="Enter your ElevenLabs API key" />
        <small>Get your API key from <a href="https://elevenlabs.io/speech-synthesis" target="_blank">ElevenLabs</a></small>
      </div>
      <div class="voice-modal-actions">
        <button id="save-voice-settings" class="voice-save-btn">Save Settings</button>
        <button id="close-voice-modal" class="voice-close-btn">Close</button>
      </div>
    </div>
  </div>

  <script>
  // --- Enhanced Research-Based Stories ---
  const STORIES = {
    evie: {
      Unicorns: {
        text: "Pink unicorn, pink unicorn, what do you see? I see a shiny horn sparkling at me. Jump jump, run run, fun fun! Say it with me: <b>u-ni-corn</b>. What rhymes with horn? (Try: corn!) Let's read it again together!",
        imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=600&h=400&fit=crop&crop=center&q=unicorn+magical+fantasy"
      },
      Dolls: {
        text: "Doll doll, pretty doll, with hair so long. Dress is purple, sing a song. Smile smile, play play, all day! Sound it out: <b>d-o-ll</b>. What color is your doll's dress? Let's imagine and read more!",
        imageUrl: "https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=600&h=400&fit=crop&crop=center"
      },
      'Toy Babies': {
        text: "Baby baby, cute cute, with bottle small. Laugh laugh, hug hug, love all! Sleep sleep, dream dream, sweet! Phonics fun: <b>b-a-by</b>. How do you care for a baby? Read and think!",
        imageUrl: "https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=600&h=400&fit=crop&crop=center"
      },
      'Colors & Shapes': {
        text: "Red red circle, round and bright. Blue blue square, what a sight! Yellow star, twinkle twinkle. Colors shapes, fun to mingle! Say: <b>red</b>, <b>blue</b>. What shape is a ball? Let's find out!",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center"
      },
      'Cute Animals': {
        text: "Cat cat, meow meow, soft and fluffy. Dog dog, woof woof, so puffy! Bird bird, tweet tweet, fly high. Animals cute, oh my my! <b>C-a-t</b>, repeat! What animal says quack? Read on!",
        imageUrl: "https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=600&h=400&fit=crop&crop=center"
      },
      'Fairy Friends': {
        text: "Fairy fairy, wings wings, sparkle bright. Fly fly, magic magic, day and night. Friend friend, play play, delight! <b>F-a-i-ry</b>, say it right. Who is your fairy friend? Let's story time!",
        imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=600&h=400&fit=crop&crop=center"
      },
      'Magic Toys': {
        text: "Toy toy, magic magic, bounce so high. Train train, choo choo, zoom by! Ball ball, roll roll, oh my! <b>M-a-gic</b>, try! What magic toy do you have? Read and dream!",
        imageUrl: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop&crop=center"
      },
      'Happy Family': {
        text: "Mom mom, dad dad, hug hug tight. Sister sister, brother brother, light light bright. Family family, love love, right! <b>F-a-m-i-ly</b>, sight! What makes your family happy? Share and read!",
        imageUrl: "https://images.unsplash.com/photo-1511895426328-dc8714191300?w=600&h=400&fit=crop&crop=center"
      }
    },
    annabella: {
      'Unicorn Legends': {
        text: "Long ago, people told <span class='vocabulary-highlight'>legends</span> about unicorns with magical healing powers. In ancient China, a unicorn called a 'qilin' was said to appear when a wise ruler was born. European stories described unicorns that could purify poisoned water with their horns. Some legends claimed only people with pure hearts could approach these mystical creatures. Today, we know these are myths, but they teach us about hope and goodness. What makes a legend different from a regular story? Legends often explain something mysterious or teach important <span class='vocabulary-highlight'>values</span> like kindness and bravery. Many cultures around the world have their own unicorn-like creatures in their folklore.",
        imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['legends', 'values', 'mystical', 'folklore'],
        comprehension: [
          {
            type: 'Connection',
            question: 'How do the unicorn legends from China and Europe compare? What do they have in common?'
          },
          {
            type: 'Inference',
            question: 'Why do you think many cultures created stories about magical creatures like unicorns?'
          },
          {
            type: 'Vocabulary',
            question: 'The text mentions "values." What values do unicorn legends teach us?'
          }
        ],
        readingTips: 'Ask your child to make connections to other legends or fairy tales they know. Encourage them to predict what might happen next in stories.'
      },
      'Ocean Explorers': {
        text: "The ocean covers more than 70% of Earth's surface, yet we've only explored about 5% of it! <span class='vocabulary-highlight'>Marine biologists</span> are scientists who study ocean life. They use special submarines called submersibles to dive deep underwater. The deepest part of the ocean, the Mariana Trench, is nearly seven miles down‚Äîthat's deeper than Mount Everest is tall! In the dark depths, amazing creatures create their own light through <span class='vocabulary-highlight'>bioluminescence</span>. Some jellyfish glow blue, while certain fish have lights like tiny flashlights. Ocean explorers have discovered <span class='vocabulary-highlight'>species</span> of fish that live near underwater volcanoes. These <span class='vocabulary-highlight'>extreme environments</span> help us understand how life might exist on other planets!",
        imageUrl: "https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['marine biologists', 'bioluminescence', 'species', 'extreme environments'],
        comprehension: [
          {
            type: 'Main Idea',
            question: 'What is the main idea of this passage about ocean exploration?'
          },
          {
            type: 'Compare/Contrast',
            question: 'How is the deepest part of the ocean similar to the height of Mount Everest?'
          },
          {
            type: 'Prediction',
            question: 'Based on what you read, what do you think ocean explorers might discover next?'
          }
        ],
        readingTips: 'Help your child visualize the ocean depths by comparing them to familiar landmarks. Encourage questions about how sea creatures adapt to their environment.'
      },
      'Space Adventures': {
        text: "Astronauts train for years before traveling to space. They practice in giant pools underwater to simulate the feeling of <span class='vocabulary-highlight'>weightlessness</span>. The International Space Station orbits Earth every 90 minutes, traveling at 17,500 miles per hour! Up there, astronauts conduct <span class='vocabulary-highlight'>experiments</span> that help us understand how plants grow without gravity. They also study how human bodies change in space. Did you know that astronauts actually grow taller in space because their spines stretch out? Mars is our next big <span class='vocabulary-highlight'>destination</span>‚Äîit takes about 7 months to travel there. Scientists are working on growing food in space and creating <span class='vocabulary-highlight'>sustainable</span> living areas for future Mars explorers. One day, you might be able to vacation in space!",
        imageUrl: "https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['weightlessness', 'experiments', 'destination', 'sustainable'],
        comprehension: [
          {
            type: 'Sequence',
            question: 'What steps do astronauts take to prepare for space travel?'
          },
          {
            type: 'Cause/Effect',
            question: 'Why do astronauts grow taller in space? What causes this to happen?'
          },
          {
            type: 'Critical Thinking',
            question: 'What challenges might humans face when trying to live on Mars?'
          }
        ],
        readingTips: 'Connect space concepts to your child\'s daily life. Ask them to imagine what they would miss most about Earth if they lived on Mars.'
      },
      'Ancient Egypt': {
        text: "Ancient Egypt was one of the world's greatest <span class='vocabulary-highlight'>civilizations</span>, lasting over 3,000 years! The Egyptians built amazing pyramids that still stand today. The Great Pyramid of Giza was the world's tallest building for almost 4,000 years. Egyptians created <span class='vocabulary-highlight'>hieroglyphics</span>, a writing system using pictures and symbols. They wrote on papyrus, an early type of paper made from plants. Egyptian <span class='vocabulary-highlight'>pharaohs</span> were kings and queens who were considered gods. The most famous pharaoh, King Tutankhamun, became king when he was only nine years old! Egyptians believed in life after death and <span class='vocabulary-highlight'>mummified</span> bodies to preserve them. They built elaborate tombs filled with treasures for the afterlife. Their mathematical and <span class='vocabulary-highlight'>engineering</span> skills were so advanced that we still study them today.",
        imageUrl: "https://images.unsplash.com/photo-1594736797933-d0f06ba80404?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['civilizations', 'hieroglyphics', 'pharaohs', 'mummified', 'engineering'],
        comprehension: [
          {
            type: 'Timeline',
            question: 'How long did ancient Egyptian civilization last, and what does this tell us about their success?'
          },
          {
            type: 'Problem/Solution',
            question: 'What problem were the Egyptians trying to solve by mummifying bodies?'
          },
          {
            type: 'Evidence',
            question: 'What evidence from the text shows that ancient Egyptians were skilled builders and engineers?'
          }
        ],
        readingTips: 'Help your child create a timeline of events. Encourage them to compare ancient Egyptian innovations to modern technology.'
      },
      'Weather Patterns': {
        text: "Weather happens because of the sun's energy heating Earth unevenly. <span class='vocabulary-highlight'>Meteorologists</span> are scientists who study and predict weather patterns. They use satellites, weather balloons, and radar to collect data. Clouds form when warm, moist air rises and cools down, just like when you see your breath on a cold day. Different cloud types signal different weather: fluffy cumulus clouds usually mean fair weather, while dark <span class='vocabulary-highlight'>cumulonimbus</span> clouds can bring thunderstorms. The water cycle connects all weather‚Äîwater evaporates from oceans, forms clouds, falls as rain, and flows back to the sea. Extreme weather like hurricanes, tornadoes, and blizzards can be dangerous, but they're natural parts of Earth's <span class='vocabulary-highlight'>climate system</span>. Understanding weather helps farmers know when to plant crops and helps people stay safe during storms.",
        imageUrl: "https://images.unsplash.com/photo-1419833479618-c595710db962?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['meteorologists', 'cumulonimbus', 'climate system', 'evaporates'],
        comprehension: [
          {
            type: 'Process',
            question: 'Explain how the water cycle creates weather patterns.'
          },
          {
            type: 'Classification',
            question: 'How do different types of clouds help predict weather?'
          },
          {
            type: 'Application',
            question: 'How might understanding weather patterns help people in different jobs?'
          }
        ],
        readingTips: 'Point out different cloud types when you\'re outside together. Encourage your child to make weather predictions based on cloud observations.'
      },
      'Animal Adaptations': {
        text: "<span class='vocabulary-highlight'>Adaptation</span> is how animals change over time to survive in their environments. Polar bears have thick white fur to stay warm and hide in Arctic snow. Desert camels store fat in their humps for energy during long journeys without food. Chameleons change colors to <span class='vocabulary-highlight'>camouflage</span> themselves from predators and communicate with other chameleons. Birds have different beak shapes for different foods: long thin beaks for nectar, strong thick beaks for seeds, and sharp curved beaks for hunting. Some animals have <span class='vocabulary-highlight'>behavioral adaptations</span> too‚Äîwolves hunt in packs, while meerkats take turns standing guard. Ocean animals show amazing adaptations: whales hold their breath for hours, and deep-sea fish create their own light. These adaptations took millions of years to develop through <span class='vocabulary-highlight'>evolution</span>.",
        imageUrl: "https://images.unsplash.com/photo-1425082661705-1834bfd09dca?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['adaptation', 'camouflage', 'behavioral adaptations', 'evolution'],
        comprehension: [
          {
            type: 'Categories',
            question: 'What are the differences between physical adaptations and behavioral adaptations?'
          },
          {
            type: 'Analysis',
            question: 'How do a polar bear\'s adaptations specifically help it survive in the Arctic?'
          },
          {
            type: 'Synthesis',
            question: 'If you could design an animal for a specific environment, what adaptations would you give it?'
          }
        ],
        readingTips: 'Ask your child to think about how pets are adapted for their environments. Encourage them to observe animal behaviors at parks or zoos.'
      },
      'Renewable Energy': {
        text: "<span class='vocabulary-highlight'>Renewable energy</span> comes from sources that never run out, like sunlight, wind, and water. Solar panels convert sunlight into electricity using <span class='vocabulary-highlight'>photovoltaic</span> cells, similar to how plants use sunlight for energy. Wind turbines have huge blades that spin in the wind to generate power‚Äîone large turbine can provide electricity for hundreds of homes! <span class='vocabulary-highlight'>Hydroelectric</span> dams use flowing water to spin generators, and some countries get most of their power this way. Geothermal energy comes from heat deep inside Earth. Iceland uses this natural heat to warm buildings and generate electricity. Unlike fossil fuels, renewable energy doesn't create <span class='vocabulary-highlight'>pollution</span> that harms our environment. Many schools now have solar panels on their roofs, and electric cars are becoming more popular. Scientists are working on new technologies like storing energy in giant batteries for when the sun isn't shining or the wind isn't blowing.",
        imageUrl: "https://images.unsplash.com/photo-1466611653911-95081537e5b7?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['renewable energy', 'photovoltaic', 'hydroelectric', 'pollution'],
        comprehension: [
          {
            type: 'Compare/Contrast',
            question: 'How is renewable energy different from fossil fuels?'
          },
          {
            type: 'Examples',
            question: 'Give three examples of renewable energy sources and explain how each one works.'
          },
          {
            type: 'Future Thinking',
            question: 'What challenges do scientists need to solve to make renewable energy even better?'
          }
        ],
        readingTips: 'Look for solar panels or wind turbines in your area. Discuss how your family could use less energy and help the environment.'
      },
      'Brain Science': {
        text: "Your brain is like a super-computer with 86 billion <span class='vocabulary-highlight'>neurons</span> that send messages to each other. Different parts of your brain have special jobs: the <span class='vocabulary-highlight'>cerebellum</span> controls balance and movement, while the frontal lobe handles thinking and decision-making. When you learn something new, your brain forms new connections called <span class='vocabulary-highlight'>synapses</span>. This is called <span class='vocabulary-highlight'>neuroplasticity</span>‚Äîyour brain can actually change and grow throughout your life! Sleep is crucial for your brain because it clears out toxins and helps form memories. Dreams happen during REM sleep when your brain is very active. Exercise increases blood flow to your brain and helps you think better. Reading, playing music, and solving puzzles all strengthen different brain regions. Scientists use special scanners like MRI machines to watch the brain in action and understand how it works.",
        imageUrl: "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=600&h=400&fit=crop&crop=center",
        vocabulary: ['neurons', 'cerebellum', 'synapses', 'neuroplasticity'],
        comprehension: [
          {
            type: 'Function',
            question: 'Explain what neuroplasticity means and why it\'s important for learning.'
          },
          {
            type: 'Connections',
            question: 'How do sleep, exercise, and learning all help your brain stay healthy?'
          },
          {
            type: 'Application',
            question: 'Based on what you learned, what activities could you do to strengthen your brain?'
          }
        ],
        readingTips: 'Connect brain functions to your child\'s daily experiences. Encourage them to notice how they feel after exercise or good sleep.'
      }
    }
  };

  // --- App state & DOM elements ---
  const el = {
    ageSection: document.getElementById('age-selection'),
    topicsPanel: document.getElementById('topics'),
    topicGrid: document.getElementById('topic-grid'),
    backToAges: document.getElementById('back-to-ages'),
    content: document.getElementById('content'),
    img: document.getElementById('story-image'),
    caption: document.getElementById('story-caption'),
    text: document.getElementById('story-text'),
    loading: document.getElementById('loading'),
    imageLoading: document.getElementById('image-loading'),
    ttsPlay: document.getElementById('tts-play'),
    ttsPause: document.getElementById('tts-pause'),
    ttsStop: document.getElementById('tts-stop'),
    voiceSettings: document.getElementById('voice-settings'),
    voiceModal: document.getElementById('voice-modal'),
    closeVoiceModal: document.getElementById('close-voice-modal'),
    saveVoiceSettings: document.getElementById('save-voice-settings'),
    apiKeyInput: document.getElementById('api-key-input'),
    elevenLabsSetup: document.getElementById('elevenlabs-setup'),
    ttsRate: document.getElementById('tts-rate'),
    ttsStatus: document.getElementById('tts-status'),
    readerName: document.getElementById('reader-name'),
    storyBreadcrumb: document.getElementById('story-breadcrumb'),
    autoPlayIndicator: document.getElementById('auto-play-indicator'),
    comprehensionSection: document.getElementById('comprehension-section'),
    comprehensionQuestions: document.getElementById('comprehension-questions'),
    readingTips: document.getElementById('reading-tips'),
    readingTipsContent: document.getElementById('reading-tips-content')
  };

  let state = {
    ageKey: null,
    subject: null,
    voice: null,
    rate: parseFloat(localStorage.getItem('tts-rate') || '0.8'),
    isReading: false,
    currentUtterance: null,
    autoPlay: false,
    useElevenLabs: localStorage.getItem('use-elevenlabs') === 'true',
    elevenLabsApiKey: localStorage.getItem('elevenlabs-api-key') || ''
  };

  // Initialize rate slider
  el.ttsRate.value = state.rate;

  // --- ElevenLabs Integration ---
  const ELEVENLABS_VOICES = {
    evie: {
      id: 'pNInz6obpgDQGcFmaJgB', // Amy - young girl voice
      name: 'Amy (4-year-old girl)'
    },
    annabella: {
      id: 'EXAVITQu4vr4xnSDxMaL', // Sarah - child narrator  
      name: 'Sarah (8-year-old girl)'
    }
  };

  async function generateElevenLabsAudio(text, ageKey) {
    if (!state.elevenLabsApiKey) {
      throw new Error('ElevenLabs API key not configured');
    }

    const voiceId = ELEVENLABS_VOICES[ageKey]?.id;
    if (!voiceId) {
      throw new Error('Voice not found for age group');
    }

    showTTSStatus('üîÆ Generating magical voice...', 0);

    try {
      const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
        method: 'POST',
        headers: {
          'Accept': 'audio/mpeg',
          'Content-Type': 'application/json',
          'xi-api-key': state.elevenLabsApiKey
        },
        body: JSON.stringify({
          text: text.substring(0, 2000), // Limit for free tier
          model_id: "eleven_flash_v2_5", // Fast, low-latency model
          voice_settings: {
            stability: ageKey === 'evie' ? 0.6 : 0.5,
            similarity_boost: 0.75,
            style: ageKey === 'evie' ? 0.3 : 0.4, // Less dramatic for younger kids
            use_speaker_boost: true
          }
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail?.message || 'ElevenLabs API error');
      }

      const audioBlob = await response.blob();
      return URL.createObjectURL(audioBlob);
    } catch (error) {
      console.error('ElevenLabs error:', error);
      showTTSStatus('‚ùå AI voice failed, using backup voice', 3000, 'warning');
      throw error;
    }
  }

  async function playElevenLabsAudio(audioUrl) {
    return new Promise((resolve, reject) => {
      const audio = new Audio(audioUrl);
      
      audio.onloadstart = () => {
        state.isReading = true;
        updateTTSButtons(true);
        const readerName = state.ageKey === 'evie' ? 'Evie' : 'Annabella';
        const voiceName = ELEVENLABS_VOICES[state.ageKey]?.name || 'AI voice';
        showTTSStatus(`üé≠ ${voiceName} reading for ${readerName}...`, 0);
      };

      audio.onended = () => {
        state.isReading = false;
        updateTTSButtons(false);
        showTTSStatus('‚úÖ Story complete!', 2000, 'success');
        URL.revokeObjectURL(audioUrl); // Clean up blob URL
        resolve();
      };

      audio.onerror = (e) => {
        state.isReading = false;
        updateTTSButtons(false);
        showTTSStatus('‚ùå Audio playback failed', 3000, 'warning');
        reject(e);
      };

      // Store reference for pause/stop functionality
      state.currentAudio = audio;
      audio.play();
    });
  }
  const synth = window.speechSynthesis;
  let voicesLoaded = false;

  function loadVoices() {
    if (voicesLoaded) return;
    
    const voices = synth.getVoices();
    if (voices.length === 0) return;
    
    voicesLoaded = true;
    
    // Prioritize child-friendly, higher-pitched voices
    const childFriendlyVoices = [
      // Female voices (typically higher pitched, more child-friendly)
      'Microsoft Zira', 'Google US English Female', 'Samantha', 'Victoria', 
      'Karen', 'Microsoft Hazel', 'Google UK English Female', 'Susan',
      'Vicki', 'Princess', 'Kathy', 'Serena', 'Allison',
      // Then male voices with higher pitch potential
      'Google US English Male', 'Microsoft Mark', 'Alex', 'Daniel', 'Tom'
    ];
    
    // Find the best child-friendly voice
    let bestVoice = null;
    
    // First try exact matches
    for (let preferred of childFriendlyVoices) {
      bestVoice = voices.find(v => v.name.includes(preferred));
      if (bestVoice) break;
    }
    
    // If no exact match, prioritize female voices (generally higher pitch)
    if (!bestVoice) {
      bestVoice = voices.find(v => 
        v.lang.startsWith('en') && 
        (v.name.toLowerCase().includes('female') || 
         v.name.toLowerCase().includes('woman') ||
         ['zira', 'samantha', 'victoria', 'karen', 'susan'].some(name => 
           v.name.toLowerCase().includes(name)))
      );
    }
    
    // Final fallback to any English voice
    if (!bestVoice) {
      bestVoice = voices.find(v => 
        v.lang.startsWith('en') && (v.localService || v.default)
      ) || voices.find(v => v.lang.startsWith('en')) || voices[0];
    }
    
    state.voice = bestVoice;
    console.log('Selected child-friendly voice:', bestVoice?.name || 'None available');
  }

  // Load voices when available
  synth.onvoiceschanged = loadVoices;
  loadVoices(); // Try immediately in case voices are already loaded

  // --- Event Listeners ---
  document.querySelectorAll('.chip[data-age]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.ageKey = btn.dataset.age;
      state.autoPlay = (state.ageKey === 'evie'); // Auto-play for Evie only
      showTopics(state.ageKey);
    });
  });

  el.backToAges.addEventListener('click', () => {
    stopTTS();
    el.topicsPanel.classList.add('hidden');
    el.content.classList.add('hidden');
    el.ageSection.classList.remove('hidden');
    el.topicGrid.innerHTML = '';
    state.ageKey = null;
    state.autoPlay = false;
  });

  document.getElementById('back-to-topics').addEventListener('click', () => {
    stopTTS();
    el.content.classList.add('hidden');
    el.topicsPanel.classList.remove('hidden');
  });

  function showTopics(ageKey) {
    el.ageSection.classList.add('hidden');
    el.topicsPanel.classList.remove('hidden');
    el.topicGrid.innerHTML = '';
    
    // Update breadcrumb
    const readerName = ageKey === 'evie' ? 'üå∏ Evie' : '‚ú® Annabella';
    el.readerName.textContent = readerName;
    
    const topics = Object.keys(STORIES[ageKey] || {});
    topics.forEach(name => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = name;
      b.addEventListener('click', () => loadStory(ageKey, name));
      el.topicGrid.appendChild(b);
    });
  }

  async function getStory({ ageKey, subject }) {
    return STORIES[ageKey]?.[subject] ?? null;
  }

  async function loadStory(ageKey, subject) {
    stopTTS();
    state.subject = subject;
    el.loading.classList.remove('hidden');
    el.topicsPanel.classList.add('hidden');
    el.content.classList.remove('hidden');
    el.text.innerHTML = '';
    el.img.classList.add('hidden');
    el.imageLoading.classList.remove('hidden');
    el.comprehensionSection.classList.add('hidden');
    el.readingTips.classList.add('hidden');
    
    // Update breadcrumb
    const readerName = ageKey === 'evie' ? 'üå∏ Evie' : '‚ú® Annabella';
    el.storyBreadcrumb.textContent = `${readerName} ‚Üí ${subject}`;
    
    // Show/hide auto-play indicator
    if (state.autoPlay) {
      el.autoPlayIndicator.classList.remove('hidden');
    } else {
      el.autoPlayIndicator.classList.add('hidden');
    }
    
    try {
      // Add a brief loading animation
      await new Promise(r => setTimeout(r, 600));
      const data = await getStory({ ageKey, subject });
      if (!data) throw new Error('No story found');

      // Create clickable words
      const words = data.text.split(/(\s+)/).map(segment => {
        if (segment.trim()) {
          const span = document.createElement('span');
          span.className = 'word';
          span.innerHTML = segment; // Preserve HTML like <b> tags
          span.setAttribute('tabindex', '0');
          span.setAttribute('role', 'button');
          span.setAttribute('aria-label', `Click to hear: ${span.textContent}`);
          span.addEventListener('click', () => speakWord(span.textContent));
          span.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              speakWord(span.textContent);
            }
          });
          return span.outerHTML;
        }
        return segment;
      }).join('');

      el.text.innerHTML = words;

      // Load image with better loading states
      if (data.imageUrl) {
        const img = new Image();
        img.onload = () => {
          el.img.src = data.imageUrl;
          el.img.alt = `${subject} illustration - a beautiful scene showing ${subject.toLowerCase()}`;
          el.img.classList.remove('hidden');
          el.imageLoading.classList.add('hidden');
          el.caption.textContent = subject;
        };
        img.onerror = () => {
          el.imageLoading.textContent = 'Image unavailable';
          setTimeout(() => el.imageLoading.classList.add('hidden'), 2000);
        };
        img.src = data.imageUrl;
      } else {
        el.imageLoading.classList.add('hidden');
      }
      
      // Show comprehension section for Annabella
      if (ageKey === 'annabella' && data.comprehension) {
        showComprehensionQuestions(data.comprehension);
        if (data.readingTips) {
          showReadingTips(data.readingTips);
        }
      }
      
      // Auto-play for Evie after story loads
      if (state.autoPlay && state.ageKey === 'evie') {
        setTimeout(() => {
          const text = el.text.textContent.trim();
          if (text) {
            showTTSStatus('‚ú® Starting story for Evie!', 2000);
            speak(text);
          }
        }, 800);
      } else if (state.ageKey === 'annabella') {
        showTTSStatus('üìñ Story ready! Read first, then explore questions below', 3000);
      }
      
    } catch (err) {
      el.text.textContent = `Oops! Magic mishap. Try again. (${err.message})`;
      showTTSStatus('Story loading failed', 3000);
    } finally {
      el.loading.classList.add('hidden');
    }
  }

  function showComprehensionQuestions(questions) {
    el.comprehensionQuestions.innerHTML = '';
    questions.forEach(q => {
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.innerHTML = `
        <div class="question-type">${q.type}</div>
        <div class="question">${q.question}</div>
      `;
      el.comprehensionQuestions.appendChild(questionCard);
    });
    el.comprehensionSection.classList.remove('hidden');
  }

  function showReadingTips(tips) {
    el.readingTipsContent.textContent = tips;
    el.readingTips.classList.remove('hidden');
  }

  // --- Enhanced TTS Functions ---
  function updateTTSButtons(isPlaying, isPaused = false) {
    el.ttsPlay.disabled = isPlaying && !isPaused;
    el.ttsPause.disabled = !isPlaying;
    el.ttsStop.disabled = !isPlaying;
    
    // Visual feedback
    el.ttsPlay.classList.toggle('playing', isPlaying && !isPaused);
    
    if (isPlaying && !isPaused) {
      el.ttsPlay.setAttribute('aria-label', 'Reading...');
    } else {
      el.ttsPlay.setAttribute('aria-label', 'Read story aloud');
    }
  }

  function showTTSStatus(message, duration = 2000, type = 'default') {
    el.ttsStatus.textContent = message;
    el.ttsStatus.className = `tts-status ${type}`;
    el.ttsStatus.classList.add('show');
    setTimeout(() => {
      el.ttsStatus.classList.remove('show');
    }, duration);
  }

  async function speak(text) {
    if (!text || !text.trim()) return;
    
    stopTTS();
    
    // Clean text of HTML and extra whitespace
    const cleanText = text.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    if (!cleanText) return;

    // Try ElevenLabs first if enabled and configured
    if (state.useElevenLabs && state.elevenLabsApiKey) {
      try {
        const audioUrl = await generateElevenLabsAudio(cleanText, state.ageKey);
        await playElevenLabsAudio(audioUrl);
        return;
      } catch (error) {
        console.warn('ElevenLabs failed, falling back to browser TTS:', error);
        // Continue to browser TTS fallback
      }
    }

    // Browser TTS fallback
    const utterance = new SpeechSynthesisUtterance(cleanText);
    state.currentUtterance = utterance;
    
    // Configure voice settings
    if (state.voice) {
      utterance.voice = state.voice;
    }
    utterance.lang = 'en-US';
    
    // Age-appropriate settings with more child-friendly parameters
    if (state.ageKey === 'evie') {
      utterance.rate = Math.min(state.rate, 0.75); // Slower for 4-year-olds
      utterance.pitch = 1.4; // Higher pitch for child-like sound
      utterance.volume = 0.9;
    } else {
      utterance.rate = Math.max(Math.min(state.rate, 1.0), 0.8); // Moderate pace for 7-8 year olds
      utterance.pitch = 1.25; // Slightly higher pitch, still child-friendly
      utterance.volume = 0.85;
    }
    
    // Event handlers
    utterance.onstart = () => {
      state.isReading = true;
      updateTTSButtons(true);
      const readerName = state.ageKey === 'evie' ? 'Evie' : 'Annabella';
      const voiceType = state.useElevenLabs ? 'AI Voice' : 'Browser Voice';
      showTTSStatus(`üìñ ${voiceType} reading for ${readerName}...`, 0);
    };
    
    utterance.onend = () => {
      state.isReading = false;
      state.currentUtterance = null;
      updateTTSButtons(false);
      showTTSStatus('‚úÖ Story complete!', 2000, 'success');
    };
    
    utterance.onerror = (event) => {
      console.error('Speech synthesis error:', event.error);
      state.isReading = false;
      state.currentUtterance = null;
      updateTTSButtons(false);
      showTTSStatus('‚ùå Speech error occurred', 3000, 'warning');
    };
    
    synth.speak(utterance);
  }

  function speakWord(word) {
    if (!word || !word.trim()) return;
    
    const cleanWord = word.replace(/<[^>]*>/g, '').trim();
    if (!cleanWord) return;
    
    const utterance = new SpeechSynthesisUtterance(cleanWord);
    
    if (state.voice) {
      utterance.voice = state.voice;
    }
    utterance.lang = 'en-US';
    utterance.rate = state.ageKey === 'evie' ? 0.65 : 0.75; // Even slower for individual words
    utterance.pitch = state.ageKey === 'evie' ? 1.5 : 1.35; // Higher pitch for word pronunciation
    utterance.volume = 0.8;
    
    // Visual feedback for word pronunciation
    const wordElements = document.querySelectorAll('.word');
    wordElements.forEach(el => {
      if (el.textContent.trim() === cleanWord) {
        el.classList.add('speaking');
        setTimeout(() => el.classList.remove('speaking'), 500);
      }
    });
    
    synth.speak(utterance);
  }

  function pauseTTS() {
    if (synth.speaking && !synth.paused) {
      synth.pause();
      updateTTSButtons(true, true);
      showTTSStatus('‚è∏ Reading paused', 1500, 'warning');
    }
  }

  function resumeTTS() {
    if (synth.paused) {
      synth.resume();
      updateTTSButtons(true, false);
      showTTSStatus('‚ñ∂ Resumed reading', 1500);
    }
  }

  function stopTTS() {
    // Stop browser TTS
    if (synth.speaking || synth.paused) {
      if (synth.paused) synth.resume();
      synth.cancel();
    }
    
    // Stop ElevenLabs audio
    if (state.currentAudio) {
      state.currentAudio.pause();
      state.currentAudio.currentTime = 0;
      state.currentAudio = null;
    }
    
    state.isReading = false;
    state.currentUtterance = null;
    updateTTSButtons(false);
  }

  // --- Voice Settings Modal ---
  el.voiceSettings.addEventListener('click', () => {
    el.voiceModal.classList.remove('hidden');
    
    // Set current selection
    const voiceType = state.useElevenLabs ? 'elevenlabs' : 'browser';
    document.querySelector(`input[name="voice-type"][value="${voiceType}"]`).checked = true;
    
    // Show/hide ElevenLabs setup
    el.elevenLabsSetup.classList.toggle('hidden', voiceType !== 'elevenlabs');
    
    // Set API key if available
    if (state.elevenLabsApiKey) {
      el.apiKeyInput.value = state.elevenLabsApiKey;
    }
  });

  el.closeVoiceModal.addEventListener('click', () => {
    el.voiceModal.classList.add('hidden');
  });

  // Handle voice type selection
  document.addEventListener('change', (e) => {
    if (e.target.name === 'voice-type') {
      const isElevenLabs = e.target.value === 'elevenlabs';
      el.elevenLabsSetup.classList.toggle('hidden', !isElevenLabs);
    }
  });

  el.saveVoiceSettings.addEventListener('click', () => {
    const selectedVoice = document.querySelector('input[name="voice-type"]:checked').value;
    const useElevenLabs = selectedVoice === 'elevenlabs';
    
    if (useElevenLabs) {
      const apiKey = el.apiKeyInput.value.trim();
      if (!apiKey) {
        showTTSStatus('‚ùå Please enter your ElevenLabs API key', 3000, 'warning');
        return;
      }
      
      // Validate API key format (basic check)
      if (!apiKey.match(/^sk-[a-zA-Z0-9]{32}$/)) {
        showTTSStatus('‚ùå Invalid API key format', 3000, 'warning');
        return;
      }
      
      state.elevenLabsApiKey = apiKey;
      localStorage.setItem('elevenlabs-api-key', apiKey);
    }
    
    state.useElevenLabs = useElevenLabs;
    localStorage.setItem('use-elevenlabs', useElevenLabs.toString());
    
    el.voiceModal.classList.add('hidden');
    
    const voiceType = useElevenLabs ? 'ElevenLabs AI' : 'Browser';
    showTTSStatus(`‚úÖ Using ${voiceType} voices`, 2000, 'success');
  });

  // Close modal when clicking outside
  el.voiceModal.addEventListener('click', (e) => {
    if (e.target === el.voiceModal) {
      el.voiceModal.classList.add('hidden');
    }
  });

  // --- TTS Control Event Listeners ---
  el.ttsPlay.addEventListener('click', () => {
    if (synth.paused) {
      resumeTTS();
    } else {
      const text = el.text.textContent.trim();
      if (text) speak(text);
    }
  });

  el.ttsPause.addEventListener('click', pauseTTS);
  el.ttsStop.addEventListener('click', stopTTS);

  el.ttsRate.addEventListener('input', (e) => {
    state.rate = parseFloat(e.target.value);
    localStorage.setItem('tts-rate', state.rate.toString());
    
    // Show current speed
    showTTSStatus(`Speed: ${Math.round(state.rate * 100)}%`, 1000);
  });

  // --- Cleanup and Accessibility ---
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      stopTTS();
    }
  });

  window.addEventListener('beforeunload', stopTTS);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      stopTTS();
    } else if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
      e.preventDefault();
      if (state.isReading) {
        if (synth.paused) resumeTTS();
        else pauseTTS();
      } else {
        const text = el.text.textContent.trim();
        if (text) speak(text);
      }
    }
  });

  // Initialize TTS buttons state
  updateTTSButtons(false);
  </script>
</body>
</html>
