<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magical Reading Adventures ‚Äî V2 (Single File)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #fff7fb;
      --ink: #2c2152;
      --muted: #6d5db3;
      --brand-1: #ff69b4;
      --brand-2: #9370db;
      --brand-3: #ffd1dc;
      --card: #ffffffee;
      --focus: #222;
      --shadow: 0 8px 20px rgba(147,112,219,.2);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#15121c; --ink:#f7f3ff; --muted:#c8bfff; --card:#1f1a2b; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Baloo 2", system-ui, sans-serif;color:var(--ink);
      background:
        radial-gradient(60% 60% at 20% 10%, rgba(255,105,180,.25), transparent 60%),
        radial-gradient(50% 50% at 80% 0%, rgba(147,112,219,.25), transparent 60%),
        var(--bg);
    }
    .skip-link{position:absolute;left:-9999px;top:auto}
    .skip-link:focus{left:1rem;top:1rem;background:#fff;color:#000;padding:.5rem 1rem;border-radius:.5rem}

    .site-header{padding:2rem 1rem;text-align:center}
    .brand-img{width:220px;height:auto;border-radius:1rem;box-shadow:var(--shadow)}
    h1{margin:.75rem 0 0}
    .tagline{color:var(--muted)}

    .app{max-width:1000px;margin:0 auto;padding:1rem}
    .panel{background:var(--card);box-shadow:var(--shadow);border-radius:1.25rem;padding:1.25rem;margin:1rem}
    .panel-title{margin:.25rem 0 1rem}

    .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .chip{
      position:relative;
      font-size:1.1rem;padding:0;border:0;cursor:pointer;border-radius:1rem;
      background:var(--card);
      color:#3a0a4b; box-shadow:var(--shadow); min-height:72px; overflow:hidden;
    }
    .chip:focus,.chip:hover{outline:3px solid var(--focus);outline-offset:3px;transform:translateY(-1px)}
    .chip .thumb{display:block;width:100%;height:120px;object-fit:cover}
    .chip .label{display:block;padding:.75rem 1rem;background:linear-gradient(90deg,var(--brand-3), var(--brand-1));}

    .link{background:none;border:none;color:var(--brand-2);cursor:pointer;font-size:1rem;margin-top:.5rem}
    .link:focus{outline:3px solid var(--focus);outline-offset:3px}

    .controls-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .controls-row button{
      height:44px;border-radius:.75rem;border:0;background:var(--brand-2);
      color:#fff;cursor:pointer;box-shadow:var(--shadow);padding:0 12px
    }
    .controls-row button:focus{outline:3px solid var(--focus);outline-offset:3px}
    .slider{display:flex;align-items:center;gap:.5rem;color:var(--muted)}

    .story-figure{margin:1rem 0}
    .story-image{width:100%;height:auto;border-radius:1rem;box-shadow:var(--shadow)}
    .hidden{display:none}

    .story-text{font-size:1.4rem;line-height:1.7}
    .story-text .word{padding:0 .15rem;border-radius:.35rem;cursor:pointer}
    .story-text .word:hover{background:var(--brand-1);color:#fff}
    .story-text .word.current{background:var(--brand-2);color:#fff}

    .loading{font-size:1.1rem;color:var(--brand-1)}
    .site-footer{padding:2rem 1rem;text-align:center;color:var(--muted)}

    @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <a class="skip-link" href="#content">Skip to story</a>
  <header class="site-header">
    <img src="https://source.unsplash.com/random/250x125/?unicorn-magic" class="brand-img" alt="Magical unicorn illustration" />
    <h1>Magical Reading Adventures</h1>
    <p class="tagline">Pick your name to begin a story made just for you.</p>
  </header>

  <main id="app" class="app" role="main">
    <section id="age-selection" aria-label="Choose reader" class="panel">
      <h2 class="panel-title">Who is reading today?</h2>
      <div class="grid" role="list">
        <button class="chip" data-age="evie" role="listitem">
          <img class="thumb" loading="lazy" alt="Evie topics preview" src="https://source.unsplash.com/random/600x400/?unicorn"/>
          <span class="label"><span aria-hidden="true">üå∏</span> Evie (Age 4)</span>
        </button>
        <button class="chip" data-age="annabella" role="listitem">
          <img class="thumb" loading="lazy" alt="Annabella topics preview" src="https://source.unsplash.com/random/600x400/?space"/>
          <span class="label"><span aria-hidden="true">‚ú®</span> Annabella (Ages 7‚Äì8)</span>
        </button>
      </div>
    </section>

    <nav id="topics" class="panel hidden" aria-label="Choose a topic">
      <h2 class="panel-title">Pick a topic</h2>
      <div id="topic-grid" class="grid" role="list"></div>
      <button class="link" id="back-to-ages">‚Üê Back</button>
    </nav>

    <section id="content" class="panel hidden" aria-live="polite">
      <div class="controls-row" style="margin-bottom:.5rem">
        <button id="tts-play" aria-label="Read aloud">‚ñ∫</button>
        <button id="tts-pause" aria-label="Pause reading">‚ùö‚ùö</button>
        <button id="tts-stop" aria-label="Stop reading">‚ñ†</button>
        <label class="slider">Speed <input id="tts-rate" type="range" min="0.6" max="1.4" step="0.1" /></label>
        <label class="slider">Pitch <input id="tts-pitch" type="range" min="1.0" max="1.6" step="0.1" /></label>
        <label class="slider">Voice
          <select id="voice-select" aria-label="Voice selection"></select>
        </label>
      </div>

      <div class="controls-row" style="margin-bottom:.5rem">
        <button id="btn-change-img" aria-label="Add or change illustration">Add/Change Picture</button>
        <button id="btn-remove-img" aria-label="Remove illustration" style="background:#b3547a">Remove Picture</button>
        <label class="slider">Alt text
          <input id="img-alt" type="text" placeholder="Describe the picture" style="height:44px;border-radius:.75rem;border:1px solid #ddd;padding:0 .5rem"/>
        </label>
        <input id="img-picker" type="file" accept="image/*" capture="environment" class="hidden" />
      </div>

      <figure class="story-figure">
        <img id="story-image" alt="" class="story-image hidden" loading="lazy" />
        <figcaption id="story-caption" class="sr-only"></figcaption>
      </figure>

      <div id="story-text" class="story-text"></div>
      <div id="loading" class="loading hidden" role="status">Casting a spell for your story‚Ä¶</div>
      <button class="link" id="back-to-topics">‚Üê Back to topics</button>

      <details style="margin-top:1rem">
        <summary>Developer tests (click to view)</summary>
        <pre id="test-log" style="white-space:pre-wrap"></pre>
      </details>
    </section>
  </main>

  <footer class="site-footer">
    <small>Made with extra sparkles for Evie & Annabella. ¬© 2025</small>
  </footer>

  <script>
  // --- Hardcoded stories (MVP) ‚Äî pasted from your spec ---
  const STORIES = {
    evie: {
      Unicorns: {
        text: "Pink unicorn, pink unicorn, what do you see? I see a shiny horn sparkling at me. Jump jump, run run, fun fun! Say it with me: <b>u-ni-corn</b>. What rhymes with horn? (Try: corn!) Let's read it again together!",
        imageUrl: "https://source.unsplash.com/random/600x400/?unicorn"
      },
      Dolls: {
        text: "Doll doll, pretty doll, with hair so long. Dress is purple, sing a song. Smile smile, play play, all day! Sound it out: <b>d-o-ll</b>. What color is your doll's dress? Let's imagine and read more!",
        imageUrl: "https://source.unsplash.com/random/600x400/?doll"
      },
      'Toy Babies': {
        text: "Baby baby, cute cute, with bottle small. Laugh laugh, hug hug, love all! Sleep sleep, dream dream, sweet! Phonics fun: <b>b-a-by</b>. How do you care for a baby? Read and think!",
        imageUrl: "https://source.unsplash.com/random/600x400/?toy-baby"
      },
      'Colors & Shapes': {
        text: "Red red circle, round and bright. Blue blue square, what a sight! Yellow star, twinkle twinkle. Colors shapes, fun to mingle! Say: <b>red</b>, <b>blue</b>. What shape is a ball? Let's find out!",
        imageUrl: "https://source.unsplash.com/random/600x400/?colors-shapes"
      },
      'Cute Animals': {
        text: "Cat cat, meow meow, soft and fluffy. Dog dog, woof woof, so puffy! Bird bird, tweet tweet, fly high. Animals cute, oh my my! <b>C-a-t</b>, repeat! What animal says quack? Read on!",
        imageUrl: "https://source.unsplash.com/random/600x400/?cute-animals"
      },
      'Fairy Friends': {
        text: "Fairy fairy, wings wings, sparkle bright. Fly fly, magic magic, day and night. Friend friend, play play, delight! <b>F-a-i-ry</b>, say it right. Who is your fairy friend? Let's story time!",
        imageUrl: "https://source.unsplash.com/random/600x400/?fairy"
      },
      'Magic Toys': {
        text: "Toy toy, magic magic, bounce so high. Train train, choo choo, zoom by! Ball ball, roll roll, oh my! <b>M-a-gic</b>, try! What magic toy do you have? Read and dream!",
        imageUrl: "https://source.unsplash.com/random/600x400/?magic-toys"
      },
      'Happy Family': {
        text: "Mom mom, dad dad, hug hug tight. Sister sister, brother brother, light light bright. Family family, love love, right! <b>F-a-m-i-ly</b>, sight! What makes your family happy? Share and read!",
        imageUrl: "https://source.unsplash.com/random/600x400/?happy-family"
      }
    },
    annabella: {
      'Unicorn Legends': {
        text: "In ancient legends, unicorns had horns that could purify water and heal sickness. One story tells of a unicorn saving a village from poison. Fun fact: Unicorns symbolize purity in myths from Europe and Asia. Question: How might a unicorn help in real life today? Vocabulary builder: <b>leg-end</b>, <b>pu-ri-fy</b>. Discuss with a friend!",
        imageUrl: "https://source.unsplash.com/random/600x400/?unicorn-legend"
      },
      'Doll Adventures': {
        text: "Dolls aren't just toys‚Äîthey can inspire big adventures! Picture a doll sailing across oceans, discovering hidden treasures, and making allies. Educational tip: Playing with dolls builds empathy and storytelling skills. What adventure would your doll have? <b>Ad-ven-ture</b>, <b>em-pa-thy</b>. Think and create your own story!",
        imageUrl: "https://source.unsplash.com/random/600x400/?doll-adventure"
      },
      'Toy Baby Care': {
        text: "Caring for toy babies teaches real-life skills like feeding, bathing, and comforting. In reality, babies grow from newborns to toddlers, learning to walk around 1 year old. Fact: Responsibility helps kids become independent. How does baby care change as they grow? <b>Re-spon-si-bil-i-ty</b>. Try role-playing!",
        imageUrl: "https://source.unsplash.com/random/600x400/?toy-baby"
      },
      'Space Explorers': {
        text: "Space explorers like astronauts travel to the moon and beyond. Mars is red from iron oxide, and Jupiter has a giant storm called the Great Red Spot. Fact: NASA plans human missions to Mars by 2030s. What would you pack for space? <b>As-tro-naut</b>, <b>plan-et</b>. Explore more!",
        imageUrl: "https://source.unsplash.com/random/600x400/?space"
      },
      'Ocean Secrets': {
        text: "Oceans hold secrets like bioluminescent creatures that glow in the dark. The Mariana Trench is the deepest point on Earth, deeper than Everest is tall. Fact: Over 80% of oceans are unexplored. Why do fish school together? For protection! <b>O-cean</b>, <b>bi-o-lu-mi-nes-cent</b>. Dive into learning!",
        imageUrl: "https://source.unsplash.com/random/600x400/?ocean"
      },
      'Dinosaur Friends': {
        text: "Dinosaurs like Velociraptors were smart hunters, while Brachiosaurus ate plants from tall trees. Fossils show they lived 65 million years ago. Fact: Birds are modern dinosaur relatives. If dinosaurs were friends, what games would they play? <b>Di-no-saur</b>, <b>fos-sil</b>. Imagine and discuss!",
        imageUrl: "https://source.unsplash.com/random/600x400/?dinosaur"
      },
      'Science Magic': {
        text: "Science turns everyday things into magic, like making volcanoes with baking soda and vinegar‚Äîit's an acid-base reaction creating CO2 gas. Fact: This teaches chemistry basics. What 'magic' experiment can you do at home? <b>Sci-ence</b>, <b>re-ac-tion</b>. Experiment safely!",
        imageUrl: "https://source.unsplash.com/random/600x400/?science"
      },
      'History Heroes': {
        text: "History heroes like Harriet Tubman led people to freedom via the Underground Railroad. She made 13 missions, saving over 70 people. Fact: Heroes inspire change. Who is your history hero and why? <b>His-to-ry</b>, <b>he-ro</b>. Research and share!",
        imageUrl: "https://source.unsplash.com/random/600x400/?history"
      },
      'Nature Detectives': {
        text: "Nature detectives observe how bees pollinate flowers, helping plants grow fruit. Seasons change due to Earth's tilt. Fact: Trees can communicate through underground fungi networks. What nature mystery can you solve? <b>Na-ture</b>, <b>pol-li-nate</b>. Go outside and investigate!",
        imageUrl: "https://source.unsplash.com/random/600x400/?nature"
      },
      'Emotion Stories': {
        text: "Emotions like joy or anger are part of being human. In a story, a kid felt anxious about school but talked to a friend and felt better. Fact: Naming emotions helps manage them. How do you handle sad feelings? <b>E-mo-tion</b>, <b>anx-ious</b>. Share your story!",
        imageUrl: "https://source.unsplash.com/random/600x400/?emotions"
      }
    }
  };

  // --- App state & helpers ---
  const el = {
    ageSection: document.getElementById('age-selection'),
    topicsPanel: document.getElementById('topics'),
    topicGrid: document.getElementById('topic-grid'),
    backToAges: document.getElementById('back-to-ages'),
    content: document.getElementById('content'),
    img: document.getElementById('story-image'),
    caption: document.getElementById('story-caption'),
    text: document.getElementById('story-text'),
    loading: document.getElementById('loading'),
    ttsPlay: document.getElementById('tts-play'),
    ttsPause: document.getElementById('tts-pause'),
    ttsStop: document.getElementById('tts-stop'),
    ttsRate: document.getElementById('tts-rate'),
    ttsPitch: document.getElementById('tts-pitch'),
    voiceSelect: document.getElementById('voice-select'),
    imgPicker: document.getElementById('img-picker'),
    btnChangeImg: document.getElementById('btn-change-img'),
    btnRemoveImg: document.getElementById('btn-remove-img'),
    imgAltInput: document.getElementById('img-alt'),
  };

  let state = {
    ageKey: null,
    subject: null,
    voice: null,
    voices: [],
    voiceName: null,
    rate: parseFloat(localStorage.getItem('tts-rate') || 0.8),
    pitch: parseFloat(localStorage.getItem('tts-pitch') || 1.2),
  };
  el.ttsRate.value = state.rate;
  el.ttsPitch.value = state.pitch;

  const synth = window.speechSynthesis;
  function populateVoices(){
    const voices = synth.getVoices().filter(v => /^en/i.test(v.lang));
    state.voices = voices;
    el.voiceSelect.innerHTML = '';
    const prefer = [/Google/i, /Microsoft/i, /Natural/i, /US English/i];
    voices.sort((a,b)=>{
      const aScore = prefer.reduce((s,r)=> s + (r.test(a.name)?1:0),0);
      const bScore = prefer.reduce((s,r)=> s + (r.test(b.name)?1:0),0);
      return bScore - aScore;
    });
    voices.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      el.voiceSelect.appendChild(opt);
    });
    const saved = localStorage.getItem(`tts-voice-${state.ageKey||'default'}`);
    if(saved && voices.find(v=>v.name===saved)){
      state.voiceName = saved;
      el.voiceSelect.value = saved;
    } else if (voices[0]){
      state.voiceName = voices[0].name;
      el.voiceSelect.value = voices[0].name;
    }
  }
  if ('onvoiceschanged' in synth) synth.onvoiceschanged = populateVoices;
  populateVoices();

  document.querySelectorAll('.chip[data-age]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.ageKey = btn.dataset.age;
      const saved = localStorage.getItem(`tts-voice-${state.ageKey}`);
      if(saved) state.voiceName = saved;
      showTopics(state.ageKey);
      populateVoices();
    });
  });

  el.backToAges.addEventListener('click', () => {
    stopTTS();
    el.topicsPanel.classList.add('hidden');
    el.content.classList.add('hidden');
    el.ageSection.classList.remove('hidden');
    el.topicGrid.innerHTML = '';
  });

  document.getElementById('back-to-topics').addEventListener('click', () => {
    stopTTS();
    el.content.classList.add('hidden');
    el.topicsPanel.classList.remove('hidden');
  });

  function showTopics(ageKey){
    el.ageSection.classList.add('hidden');
    el.topicsPanel.classList.remove('hidden');
    el.topicGrid.innerHTML = '';
    const topics = Object.keys(STORIES[ageKey] || {});
    topics.forEach(name => {
      const b = document.createElement('button');
      b.className = 'chip';
      const imgSrc = getSavedImage(ageKey, name) || STORIES[ageKey][name].imageUrl || 'https://source.unsplash.com/random/600x400/?storybook';
      b.innerHTML = `<img class="thumb" loading="lazy" alt="${name} preview" src="${imgSrc}"><span class="label">${name}</span>`;
      b.addEventListener('click', () => loadStory(ageKey, name));
      el.topicGrid.appendChild(b);
      // Preload default/story images for snappy display
      const preload = new Image(); preload.src = imgSrc;
    });
  }

  function keyForImage(ageKey, subject){ return `img-${ageKey}-${subject}`; }
  function getSavedImage(ageKey, subject){ return localStorage.getItem(keyForImage(ageKey, subject)); }
  function saveImage(ageKey, subject, dataUrl){ localStorage.setItem(keyForImage(ageKey, subject), dataUrl); }
  function removeImage(ageKey, subject){ localStorage.removeItem(keyForImage(ageKey, subject)); }

  async function getStory({ ageKey, subject }){
    // MVP: return from hardcoded content
    return STORIES[ageKey]?.[subject] ?? null;
  }

  async function loadStory(ageKey, subject){
    stopTTS();
    state.subject = subject;
    el.loading.classList.remove('hidden');
    el.topicsPanel.classList.add('hidden');
    el.content.classList.remove('hidden');
    el.text.innerHTML = '';
    el.img.classList.add('hidden');
    try{
      await new Promise(r => setTimeout(r, 150));
      const data = await getStory({ ageKey, subject });
      if(!data) throw new Error('No story found');

      const words = data.text.split(/\s+/).map(w => {
        const span = document.createElement('span');
        span.className = 'word';
        span.innerHTML = w; // keep <b> from text
        span.addEventListener('click', () => speak(span.textContent));
        return span.outerHTML;
      }).join(' ');

      el.text.innerHTML = words;

      const saved = getSavedImage(ageKey, subject);
      const finalSrc = saved || data.imageUrl || 'https://source.unsplash.com/random/600x400/?storybook';
      el.img.src = finalSrc;
      el.img.alt = document.getElementById('img-alt').value || `${subject} illustration`;
      el.img.onload = ()=> el.img.classList.remove('hidden');
      el.img.onerror = ()=>{ el.img.src = 'https://via.placeholder.com/800x450?text=Image+unavailable'; el.img.classList.remove('hidden'); };
      el.caption.textContent = subject;
      el.imgAltInput.value = el.img.alt;
    } catch(err){
      el.text.textContent = `Oops! Magic mishap. Try again. (${err.message})`;
    } finally {
      el.loading.classList.add('hidden');
    }
  }

  // --- Image controls ---
  el.btnChangeImg.addEventListener('click', ()=>{
    if(!state.ageKey || !state.subject){ alert('Open a story first.'); return; }
    el.imgPicker.click();
  });
  el.imgPicker.addEventListener('change', (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = reader.result;
      saveImage(state.ageKey, state.subject, dataUrl);
      el.img.src = dataUrl;
      el.img.classList.remove('hidden');
      // Refresh topic thumbnails to reflect new image
      showTopics(state.ageKey);
    };
    reader.readAsDataURL(file);
  });
  el.btnRemoveImg.addEventListener('click', ()=>{
    if(!state.ageKey || !state.subject){ alert('Open a story first.'); return; }
    removeImage(state.ageKey, state.subject);
    // Revert to story default
    const data = STORIES[state.ageKey]?.[state.subject];
    const fallback = (data && data.imageUrl) || 'https://source.unsplash.com/random/600x400/?storybook';
    el.img.src = fallback;
    el.img.classList.remove('hidden');
    showTopics(state.ageKey);
  });
  el.imgAltInput.addEventListener('input', ()=>{
    if(el.imgAltInput.value != null) el.img.alt = el.imgAltInput.value;
  });

  // --- TTS controls ---
  el.ttsPlay.addEventListener('click', () => {
    const text = el.text.textContent.trim();
    if(text) speak(text);
  });
  el.ttsPause.addEventListener('click', () => {
    if (synth.speaking && !synth.paused) synth.pause();
  });
  el.ttsStop.addEventListener('click', stopTTS);
  el.ttsRate.addEventListener('input', (e) => {
    state.rate = parseFloat(e.target.value);
    localStorage.setItem('tts-rate', state.rate);
  });
  el.ttsPitch.addEventListener('input', (e) => {
    state.pitch = parseFloat(e.target.value);
    localStorage.setItem('tts-pitch', state.pitch);
  });
  el.voiceSelect.addEventListener('change', (e)=>{
    state.voiceName = e.target.value;
    if(state.ageKey){ localStorage.setItem(`tts-voice-${state.ageKey}`, state.voiceName); }
  });

  function speak(text){
    if(!text) return;
    stopTTS();
    const u = new SpeechSynthesisUtterance(text);
    const voice = (state.voiceName && state.voices.find(v=>v.name===state.voiceName)) || state.voice || null;
    u.voice = voice;
    u.lang = (voice && voice.lang) || 'en-US';
    u.rate = state.ageKey === 'evie' ? Math.min(state.rate, 0.9) : Math.min(Math.max(state.rate, 0.9), 1.2);
    u.pitch = state.ageKey === 'evie' ? Math.max(state.pitch, 1.2) : state.pitch;
    const meta = indexWordBoundaries();
    u.onboundary = function(e){ if(e.charIndex>=0){ highlightByCharIndex(e.charIndex, meta); } };
    u.onend = function(){ document.querySelectorAll('.story-text .word').forEach(s=>s.classList.remove('current')); };
    synth.speak(u);
  }

  function indexWordBoundaries(){
    const spans = Array.from(document.querySelectorAll('.story-text .word'));
    let starts = [];
    let idx = 0;
    spans.forEach((s)=>{
      const txt = s.textContent;
      starts.push({start: idx});
      idx += (txt? txt.length : 0) + 1; // +1 for spaces
    });
    return starts;
  }
  function highlightByCharIndex(charIndex, meta){
    if(!meta || !meta.length) return;
    let current = 0;
    for(let k=0;k<meta.length;k++){
      const nextStart = meta[k+1]? meta[k+1].start : Infinity;
      if(charIndex >= meta[k].start && charIndex < nextStart){ current = k; break; }
    }
    const spans = document.querySelectorAll('.story-text .word');
    spans.forEach(s=>s.classList.remove('current'));
    if(spans[current]) spans[current].classList.add('current');
  }
  function stopTTS(){ if(synth.paused) synth.resume(); synth.cancel(); }
  document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') stopTTS(); });
  window.addEventListener('beforeunload', stopTTS);

  // -----------------------------
  // Minimal developer tests
  // -----------------------------
  (function runTests(){
    const logEl = document.getElementById('test-log');
    const log = (msg, ok=true) => {
      const line = (ok? '‚úÖ ' : '‚ùå ') + msg + '\n';
      if (logEl) logEl.textContent += line; console[(ok?'log':'error')](line);
    };
    try {
      // Test 1: UI controls present
      log('Controls exist', !!(el.ttsPlay && el.ttsPause && el.ttsStop && el.ttsRate && el.ttsPitch && el.voiceSelect && el.btnChangeImg));

      // Test 2: Topics render matches data length for Evie
      const n = Object.keys(STORIES.evie).length;
      showTopics('evie');
      const rendered = document.querySelectorAll('#topic-grid .chip').length;
      log(`Topics render for Evie (${rendered}/${n})`, rendered === n);

      // Test 3: getStory returns data
      getStory({ageKey:'evie', subject:'Unicorns'}).then(s=>{
        log('getStory returns Unicorns for Evie', !!(s && s.text));
      });

      // Test 4: image key generation stable
      log('Image key stable', keyForImage('evie','Unicorns') === 'img-evie-Unicorns');

      // Cleanup UI back to ages
      el.backToAges.click();
    } catch(e){ log('Unexpected test runner error: ' + e.message, false); }
  })();
  </script>
</body>
</html>
